{% extends "base.html" %}

{% block title %}Email Template Editor - Withdean Youth FC{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="mb-0">
                    <i class="fas fa-edit text-danger"></i>
                    Email Template Editor
                </h1>
                <div class="btn-group">
                    <a href="{{ url_for('settings.settings_view') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Settings
                    </a>
                    <a href="{{ url_for('tasks.view_tasks') }}" class="btn btn-outline-info">
                        <i class="fas fa-external-link-alt"></i> Test (Go to Tasks)
                    </a>
                </div>
            </div>

            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Template Tips:</strong> Use HTML for rich formatting. Merge fields are replaced with actual fixture data.
                The preview on the right shows how your template will render.
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left Column: Editor -->
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-code"></i> Template Code
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div class="mb-3">
                            <label for="template_content" class="form-label fw-bold">Email Template (HTML)</label>
                            <textarea class="form-control" id="template_content" name="template_content"
                                      rows="15" required
                                      style="font-family: 'Courier New', monospace; font-size: 13px;"
                                      placeholder="Enter your email template HTML here...">{{ template_content }}</textarea>
                            <div class="form-text small">
                                <i class="fas fa-lightbulb me-1"></i>
                                Use double curly braces for merge fields like <code>{{date_display}}</code>.
                                Example: <code><h3>Match Details</h3></code> for headings.
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">Quick Insert Merge Field</label>
                            <div class="input-group">
                                <select class="form-select" id="merge_field_selector">
                                    <option value="">-- Click to select merge field --</option>
                                    <optgroup label="ðŸ“… Match Details">
                                        <option value="{{date_display}}">Date Display</option>
                                        <option value="{{time_display}}">Kick-off Time</option>
                                        <option value="{{team_name}}">Your Team Name</option>
                                        <option value="{{opposition_name}}">Opposition Team</option>
                                        <option value="{{match_format}}">Match Format (e.g., 9v9)</option>
                                        <option value="{{home_away}}">Home/Away</option>
                                    </optgroup>
                                    <optgroup label="ðŸ“ Venue Information">
                                        <option value="{{pitch_name}}">Pitch/Venue Name</option>
                                        <option value="{{pitch_address}}">Venue Address</option>
                                        <option value="{{pitch_parking}}">Parking Details</option>
                                        <option value="{{pitch_toilets}}">Toilet Facilities</option>
                                        <option value="{{pitch_opening_notes}}">Setup Notes</option>
                                        <option value="{{pitch_warm_up_notes}}">Warm-up Instructions</option>
                                        <option value="{{pitch_special_instructions}}">Special Instructions</option>
                                    </optgroup>
                                    <optgroup label="ðŸ—ºï¸ Maps & Links">
                                        <option value="{{pitch_google_maps_link}}">Google Maps Link</option>
                                        <option value="{{pitch_map_section}}">Map Image Section</option>
                                    </optgroup>
                                    <optgroup label="ðŸ† Colors & Contacts">
                                        <option value="{{home_colours}}">Team Colors</option>
                                        <option value="{{referee_note}}">Referee Information</option>
                                    </optgroup>
                                    <optgroup label="ðŸ‘¤ Manager Information">
                                        <option value="{{manager_name}}">Manager Name</option>
                                        <option value="{{manager_email}}">Manager Email</option>
                                        <option value="{{manager_phone}}">Manager Phone</option>
                                        <option value="{{manager_contact}}">Manager Contact (fallback)</option>
                                        <option value="{{email_signature}}">Your Email Signature</option>
                                    </optgroup>
                                    <optgroup label="ðŸ“ Content Sections">
                                        <option value="{{further_instructions_section}}">Further Instructions</option>
                                    </optgroup>
                                </select>
                                <button type="button" class="btn btn-success" id="insert_merge_field">
                                    <i class="fas fa-plus-circle"></i> Insert
                                </button>
                            </div>
                            <div class="form-text small">
                                Select a merge field and click Insert. The field will be added at your cursor position.
                            </div>
                        </div>

                        <div class="d-flex gap-2 flex-wrap">
                            <button type="submit" name="action" value="save" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                            <button type="submit" name="action" value="reset" class="btn btn-warning"
                                    onclick="return confirm('Reset to default template? Your customizations will be lost.')">
                                <i class="fas fa-undo"></i> Reset Default
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="clearTemplate()">
                                <i class="fas fa-trash"></i> Clear All
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Column: Preview & Tools -->
        <div class="col-lg-6">
            <!-- Live Preview -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-eye"></i> Live Preview
                    </h5>
                    <button class="btn btn-light btn-sm" onclick="updatePreview()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div class="alert alert-light small">
                        <i class="fas fa-info-circle text-info"></i>
                        <strong>Preview shows:</strong> How your template will look with sample fixture data. Real emails will use actual fixture information.
                    </div>
                    <div class="border rounded p-3 bg-white">
                        <div id="template-preview" style="font-family: 'Segoe UI', Arial, sans-serif; font-size: 14px; line-height: 1.5;">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin me-2"></i>Loading preview...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Merge Fields -->
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-magic"></i> Quick Insert Buttons
                    </h6>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-3">Click any button below to instantly insert that merge field:</p>

                    <div class="row g-2">
                        <!-- Match Info -->
                        <div class="col-md-6">
                            <h6 class="text-primary small fw-bold"><i class="fas fa-calendar-day"></i> Match Info</h6>
                            <div class="d-grid gap-1 mb-3">
                                <button class="btn btn-outline-primary btn-sm merge-quick-btn" data-field="{{date_display}}">
                                    Date
                                </button>
                                <button class="btn btn-outline-primary btn-sm merge-quick-btn" data-field="{{time_display}}">
                                    Time
                                </button>
                                <button class="btn btn-outline-primary btn-sm merge-quick-btn" data-field="{{team_name}}">
                                    Your Team
                                </button>
                                <button class="btn btn-outline-primary btn-sm merge-quick-btn" data-field="{{opposition_name}}">
                                    Opposition
                                </button>
                            </div>
                        </div>

                        <!-- Location Info -->
                        <div class="col-md-6">
                            <h6 class="text-success small fw-bold"><i class="fas fa-map-marker-alt"></i> Venue</h6>
                            <div class="d-grid gap-1 mb-3">
                                <button class="btn btn-outline-success btn-sm merge-quick-btn" data-field="{{pitch_name}}">
                                    Pitch Name
                                </button>
                                <button class="btn btn-outline-success btn-sm merge-quick-btn" data-field="{{pitch_address}}">
                                    Address
                                </button>
                                <button class="btn btn-outline-success btn-sm merge-quick-btn" data-field="{{pitch_parking}}">
                                    Parking
                                </button>
                                <button class="btn btn-outline-success btn-sm merge-quick-btn" data-field="{{manager_name}}">
                                    Manager
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- HTML Helpers -->
                    <div class="mb-3">
                        <h6 class="text-warning small fw-bold"><i class="fas fa-code"></i> HTML Formatting</h6>
                        <div class="d-flex flex-wrap gap-1">
                            <button class="btn btn-outline-warning btn-sm html-helper" data-html="<h3>Heading</h3>"><h3></button>
                            <button class="btn btn-outline-warning btn-sm html-helper" data-html="<strong>Bold</strong>"><strong></button>
                            <button class="btn btn-outline-warning btn-sm html-helper" data-html="<em>Italic</em>"><em></button>
                            <button class="btn btn-outline-warning btn-sm html-helper" data-html="<u>Underline</u>"><u></button>
                            <button class="btn btn-outline-warning btn-sm html-helper" data-html="<br>"><br></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.merge-quick-btn {
    font-size: 11px;
    padding: 0.25rem 0.5rem;
}

.html-helper {
    font-size: 10px;
    padding: 0.2rem 0.4rem;
}
</style>

<script>
// Insert merge field at cursor position
function insertAtCursor(textarea, text) {
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const currentValue = textarea.value;

    textarea.value = currentValue.substring(0, start) + text + currentValue.substring(end);
    textarea.selectionStart = textarea.selectionEnd = start + text.length;
    textarea.focus();
    updatePreview();
}

// Quick merge field buttons
document.querySelectorAll('.merge-quick-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const field = this.dataset.field;
        const textarea = document.getElementById('template_content');
        insertAtCursor(textarea, field);
    });
});

// HTML helper buttons
document.querySelectorAll('.html-helper').forEach(btn => {
    btn.addEventListener('click', function() {
        const html = this.dataset.html;
        const textarea = document.getElementById('template_content');
        insertAtCursor(textarea, html);
    });
});

// Dropdown insert button
document.getElementById('insert_merge_field').addEventListener('click', function() {
    const selector = document.getElementById('merge_field_selector');
    const field = selector.value;

    if (!field) {
        alert('Please select a merge field first.');
        return;
    }

    const textarea = document.getElementById('template_content');
    insertAtCursor(textarea, field);
    selector.value = ''; // Reset dropdown
});

// Update preview as user types with debounce
let previewTimer;
document.getElementById('template_content').addEventListener('input', function() {
    clearTimeout(previewTimer);
    previewTimer = setTimeout(updatePreview, 300);
});

function updatePreview() {
    const template = document.getElementById('template_content').value;
    const preview = document.getElementById('template-preview');

    if (!template.trim()) {
        preview.innerHTML = '<div class="text-center text-muted"><i class="fas fa-code fa-2x mb-2"></i><p>Start typing your HTML template to see a preview here.</p><p class="small">Try pasting some HTML like: <h3>Match Details</h3></p></div>';
        return;
    }

    // Replace merge fields with preview data - BOLD formatting makes it clear
    let previewContent = template
        .replace(/\{\{date_display\}\}/g, '<strong>Sunday 15 October 2023</strong>')
        .replace(/\{\{time_display\}\}/g, '<strong>2:30pm</strong>')
        .replace(/\{\{team_name\}\}/g, '<strong>U14 Blue</strong>')
        .replace(/\{\{opposition_name\}\}/g, '<strong>Brighton Hawks</strong>')
        .replace(/\{\{home_away\}\}/g, '<strong>Home</strong>')
        .replace(/\{\{pitch_name\}\}/g, '<strong>Stanley Deason 3G</strong>')
        .replace(/\{\{pitch_address\}\}/g, 'Stanley Deason Leisure Centre, 120 Wilson Avenue, BN2 5BP')
        .replace(/\{\{pitch_parking\}\}/g, 'Ample free parking available at the leisure centre')
        .replace(/\{\{pitch_toilets\}\}/g, 'Toilets available within the main building')
        .replace(/\{\{pitch_opening_notes\}\}/g, '3G pitch opens at 9am. Please arrive in time to mark pitch.')
        .replace(/\{\{pitch_warm_up_notes\}\}/g, '20 minutes warm-up allowed before kick-off')
        .replace(/\{\{pitch_special_instructions\}\}/g, 'Strict footwear policy - flat soled boots only')
        .replace(/\{\{pitch_google_maps_link\}\}/g, '<a href="#" class="text-decoration-none"><strong>View on Google Maps</strong></a>')
        .replace(/\{\{pitch_map_section\}\}/g, '<em class="text-muted">[Map image would appear here]</em>')
        .replace(/\{\{home_colours\}\}/g, 'Withdean Youth FC play in <strong>Blue and Black Shirts</strong>, <strong>Black Shorts</strong> and <strong>Blue and Black Hooped Socks</strong>')
        .replace(/\{\{match_format\}\}/g, '<strong>9v9 - 60 minutes - 30 each way</strong>')
        .replace(/\{\{referee_note\}\}/g, 'Referees have been requested but are TBC')
        .replace(/\{\{manager_name\}\}/g, '<strong>John Smith</strong>')
        .replace(/\{\{manager_email\}\}/g, '<em>john.smith@withdean.com</em>')
        .replace(/\{\{manager_phone\}\}/g, '<em>07123 456789</em>')
        .replace(/\{\{manager_contact\}\}/g, '<em>john.smith@withdean.com</em>')
        .replace(/\{\{email_signature\}\}/g, '<strong>Many thanks<br>Withdean Youth FC</strong>')
        .replace(/\{\{further_instructions_section\}\}/g, '<em class="text-muted">[Any additional instructions would appear here]</em>');

    preview.innerHTML = '<div style="font-family: Arial, sans-serif; font-size: 14px; line-height: 1.4; max-width: none;">' + previewContent + '</div>';
}

function clearTemplate() {
    if (confirm('Are you sure you want to clear all template content? This cannot be undone.')) {
        document.getElementById('template_content').value = '';
        updatePreview();
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updatePreview(); // Initial preview

    // Auto-save draft in localStorage
    const textarea = document.getElementById('template_content');
    const originalContent = textarea.value;

    textarea.addEventListener('input', function() {
        const currentContent = this.value;
        if (currentContent !== originalContent) {
            localStorage.setItem('email_template_draft', currentContent);
        }
    });

    // Load draft on page load
    const draft = localStorage.getItem('email_template_draft');
    if (draft && !originalContent) {
        textarea.value = draft;
        updatePreview();
    }
});
</script>
{% endblock %}
