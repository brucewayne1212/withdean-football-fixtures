{% extends "base.html" %}

{% block title %}Email Template Editor - Withdean Youth FC{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="mb-0">
                    <i class="fas fa-edit text-danger"></i>
                    Email Template Editor
                </h1>
                <div class="btn-group">
                    <a href="{{ url_for('settings.settings_view') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Settings
                    </a>
                    <a href="{{ url_for('tasks.view_tasks') }}" class="btn btn-outline-info">
                        <i class="fas fa-external-link-alt"></i> Test (Go to Tasks)
                    </a>
                </div>
            </div>

            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Template Tips:</strong> Use HTML for rich formatting. Merge fields are replaced with actual
                fixture data.
                The preview on the right shows how your template will render.
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left Column: Editor -->
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-code"></i> Template Code
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="mb-3">
                            <label for="editor-container" class="form-label fw-bold">Email Template (Rich Text)</label>
                            <!-- Hidden input to store HTML for form submission -->
                            <input type="hidden" id="template_content" name="template_content"
                                value="{{ template_content }}">
                            <!-- Quill Editor Container -->
                            <div id="editor-container"></div>
                            <div class="form-text small mt-2">
                                <i class="fas fa-lightbulb me-1"></i>
                                Use the toolbar to format text. Merge fields like <code>{{date_display}}</code> will be
                                replaced automatically.
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">Quick Insert Merge Field</label>
                            <div class="input-group">
                                <select class="form-select" id="merge_field_selector">
                                    <option value="">-- Click to select merge field --</option>
                                    <optgroup label="ðŸ“… Match Details">
                                        <option value="date_display">Date Display</option>
                                        <option value="time_display">Kick-off Time</option>
                                        <option value="team_name">Your Team Name</option>
                                        <option value="opposition_name">Opposition Team</option>
                                        <option value="match_format">Match Format (e.g., 9v9)</option>
                                        <option value="home_away">Home/Away</option>
                                    </optgroup>
                                    <optgroup label="ðŸ“ Venue Information">
                                        <option value="pitch_name">Pitch/Venue Name</option>
                                        <option value="pitch_address">Venue Address</option>
                                        <option value="pitch_parking">Parking Details</option>
                                        <option value="pitch_toilets">Toilet Facilities</option>
                                        <option value="pitch_opening_notes">Setup Notes</option>
                                        <option value="pitch_warm_up_notes">Warm-up Instructions</option>
                                        <option value="pitch_special_instructions">Special Instructions</option>
                                    </optgroup>
                                    <optgroup label="ðŸ—ºï¸ Maps & Links">
                                        <option value="pitch_google_maps_link">Google Maps Link</option>
                                        <option value="pitch_map_section">Map Image Section</option>
                                    </optgroup>
                                    <optgroup label="ðŸ† Colors & Contacts">
                                        <option value="home_colours">Team Colors</option>
                                        <option value="referee_note">Referee Information</option>
                                    </optgroup>
                                    <optgroup label="ðŸ‘¤ Manager Information">
                                        <option value="manager_name">Manager Name</option>
                                        <option value="manager_email">Manager Email</option>
                                        <option value="manager_phone">Manager Phone</option>
                                        <option value="manager_contact">Manager Contact (fallback)</option>
                                        <option value="email_signature">Your Email Signature</option>
                                    </optgroup>
                                    <optgroup label="ðŸ“ Content Sections">
                                        <option value="further_instructions_section">Further Instructions</option>
                                    </optgroup>
                                </select>
                                <button type="button" class="btn btn-success" id="insert_merge_field">
                                    <i class="fas fa-plus-circle"></i> Insert
                                </button>
                            </div>
                            <div class="form-text small">
                                Select a merge field and click Insert. The field will be added at your cursor position.
                            </div>
                        </div>

                        <div class="d-flex gap-2 flex-wrap">
                            <button type="submit" name="action" value="save" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> Save Changes
                            </button>
                            <button type="submit" name="action" value="reset" class="btn btn-warning"
                                onclick="return confirm('Reset to default template? Your customizations will be lost.')">
                                <i class="fas fa-undo"></i> Reset Default
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="clearTemplate()">
                                <i class="fas fa-trash"></i> Clear All
                            </button>
                            <button type="button" class="btn btn-outline-dark"
                                onclick="document.getElementById('image_upload').click()">
                                <i class="fas fa-image"></i> Insert Image
                            </button>
                            <input type="file" id="image_upload" accept="image/*" style="display: none;"
                                onchange="uploadImage(this)">
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Column: Preview & Tools -->
        <div class="col-lg-6">
            <!-- Live Preview -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-eye"></i> Live Preview
                    </h5>
                    <button class="btn btn-light btn-sm" onclick="updatePreview()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                <div class="card-body">
                    <div class="alert alert-light small">
                        <i class="fas fa-info-circle text-info"></i>
                        <strong>Preview shows:</strong> How your template will look with sample fixture data. Real
                        emails will use actual fixture information.
                    </div>
                    <div class="border rounded p-3 bg-white" style="max-height: 600px; overflow-y: auto;">
                        <div id="template-preview"
                            style="font-family: 'Segoe UI', Arial, sans-serif; font-size: 14px; line-height: 1.5;">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin me-2"></i>Loading preview...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Merge Fields -->
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-magic"></i> Quick Insert Buttons
                    </h6>
                </div>
            </div>
            <div class="card-body">
                <p class="small text-muted mb-3">Click any button below to instantly insert that merge field:</p>

                <div class="row g-2">
                    <!-- Match Info -->
                    <div class="col-md-6">
                        <h6 class="text-primary small fw-bold"><i class="fas fa-calendar-day"></i> Match Info</h6>
                        <div class="d-grid gap-1 mb-3">
                            <button class="btn btn-outline-primary btn-sm merge-quick-btn" data-field="date_display">
                                Date
                            </button>
                            <button class="btn btn-outline-primary btn-sm merge-quick-btn" data-field="time_display">
                                Time
                            </button>
                            <button class="btn btn-outline-primary btn-sm merge-quick-btn" data-field="team_name">
                                Your Team
                            </button>
                            <button class="btn btn-outline-primary btn-sm merge-quick-btn" data-field="opposition_name">
                                Opposition
                            </button>
                        </div>
                    </div>

                    <!-- Location Info -->
                    <div class="col-md-6">
                        <h6 class="text-success small fw-bold"><i class="fas fa-map-marker-alt"></i> Venue</h6>
                        <div class="d-grid gap-1 mb-3">
                            <button class="btn btn-outline-success btn-sm merge-quick-btn" data-field="pitch_name">
                                Pitch Name
                            </button>
                            <button class="btn btn-outline-success btn-sm merge-quick-btn" data-field="pitch_address">
                                Address
                            </button>
                            <button class="btn btn-outline-success btn-sm merge-quick-btn" data-field="pitch_parking">
                                Parking
                            </button>
                            <button class="btn btn-outline-success btn-sm merge-quick-btn" data-field="manager_name">
                                Manager
                            </button>
                        </div>
                    </div>
                </div>

                <div class="row g-2 mt-2">
                    <!-- Colors & Contacts -->
                    <div class="col-md-6">
                        <h6 class="text-warning small fw-bold"><i class="fas fa-tshirt"></i> Colors & Contacts</h6>
                        <div class="d-grid gap-1 mb-3">
                            <button class="btn btn-outline-warning btn-sm merge-quick-btn" data-field="home_colours">
                                Team Colors
                            </button>
                            <button class="btn btn-outline-warning btn-sm merge-quick-btn" data-field="referee_note">
                                Referee Info
                            </button>
                        </div>
                    </div>

                    <!-- Maps & Links -->
                    <div class="col-md-6">
                        <h6 class="text-info small fw-bold"><i class="fas fa-map"></i> Maps & Links</h6>
                        <div class="d-grid gap-1 mb-3">
                            <button class="btn btn-outline-info btn-sm merge-quick-btn"
                                data-field="pitch_google_maps_link">
                                Google Maps Link
                            </button>
                            <button class="btn btn-outline-info btn-sm merge-quick-btn" data-field="pitch_map_section">
                                Map Image Section
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Quill Editor CDN -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<style>
    .merge-quick-btn {
        font-size: 11px;
        padding: 0.25rem 0.5rem;
    }

    .html-helper {
        font-size: 10px;
        padding: 0.2rem 0.4rem;
    }

    /* Quill Customization */
    #editor-container {
        height: 400px;
        font-family: 'Segoe UI', Arial, sans-serif;
        font-size: 14px;
    }

    .ql-editor {
        font-family: 'Segoe UI', Arial, sans-serif;
        font-size: 14px;
    }
</style>

<script>
    // Override Quill's Link sanitizer BEFORE initializing Quill
    // Quill 1.3.6 sanitizes href values and strips anything that doesn't
    // look like http/https/mailto â€” this breaks merge fields like
    // {{pitch_google_maps_link}} in href attributes, turning them into "about:blank".
    var Link = Quill.import('formats/link');
    var originalSanitize = Link.sanitize;
    Link.sanitize = function (url) {
        // Allow merge field patterns ({{...}} or URL-encoded %7B%7B...%7D%7D)
        if (url && (url.indexOf('{{') !== -1 || url.indexOf('%7B%7B') !== -1)) {
            return url; // Preserve merge fields as-is
        }
        // Fall back to default sanitization for normal URLs
        return originalSanitize.call(this, url);
    };

    // Initialize Quill
    var quill = new Quill('#editor-container', {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                ['link', 'clean'],
                ['code-block'] // Allow viewing/editing raw HTML if needed (basic)
            ]
        }
    });

    // Set initial content
    var initialContent = document.getElementById('template_content').value;
    // If content is empty/null, don't set it to avoid "null" text
    if (initialContent) {
        // Check if it looks like HTML, if not wrap in p tags? Quill handles HTML string.
        quill.clipboard.dangerouslyPasteHTML(0, initialContent);
    }

    // Sync Quill to Hidden Input on Change
    quill.on('text-change', function () {
        var html = quill.root.innerHTML;
        document.getElementById('template_content').value = html;
        updatePreview();

        // Auto-save draft
        localStorage.setItem('email_template_draft', html);
    });

    // Insert merge field at cursor position
    function insertAtCursor(text) {
        // Ensure editor has focus or we have a range
        quill.focus();
        let range = quill.getSelection();

        if (!range) {
            // If still no range, append to end
            range = { index: quill.getLength(), length: 0 };
        }

        // Special handling for Google Maps link â€” insert as a proper <a href> link
        if (text === 'pitch_google_maps_link') {
            // Insert the pitch name merge field as clickable link text
            // e.g. "Dorothy Stringer Google Maps" with the URL embedded
            const linkText = '{{pitch_name}} Google Maps';
            quill.insertText(range.index, linkText, {
                'link': '{{pitch_google_maps_link}}',
                'bold': true
            });
            quill.setSelection(range.index + linkText.length);
            return;
        }

        // Wrap text in double curly braces if not already wrapped
        const fieldText = text.startsWith('{{') ? text : '{{' + text + '}}';

        // Insert text with specific formatting if needed, or just text
        // We want the merge field to be inserted as text
        quill.insertText(range.index, fieldText, 'bold', true); // Insert as bold for visibility
        quill.setSelection(range.index + fieldText.length);
    }

    // Quick merge field buttons
    document.querySelectorAll('.merge-quick-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const field = this.dataset.field;
            insertAtCursor(field);
        });
    });

    // HTML helper buttons - For Quill these might be less useful but we can keep them
    // Or maybe remove them since Quill handles formatting?
    // Let's keep them but make them insert the HTML structure if possible, or just text?
    // Actually, with Quill, "Bold" button in toolbar is better. 
    // But let's keep them as "Quick Format" if user wants to insert raw HTML? 
    // No, inserting raw HTML into Quill via insertText escapes it.
    // We should probably hide the HTML helpers or make them use Quill formatting.
    // For now, let's just make them insert the text representation which might be confusing.
    // BETTER: Remove HTML helpers since Quill has a toolbar.
    // I will hide the HTML helpers section in the template update below.

    // Dropdown insert button
    document.getElementById('insert_merge_field').addEventListener('click', function () {
        const selector = document.getElementById('merge_field_selector');
        const field = selector.value;

        if (!field) {
            alert('Please select a merge field first.');
            return;
        }

        insertAtCursor(field);
        selector.value = ''; // Reset dropdown
    });

    // Image Upload Function
    function uploadImage(input) {
        if (input.files && input.files[0]) {
            const formData = new FormData();
            formData.append('image', input.files[0]);
            formData.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);

            // Show loading
            const editorContainer = document.getElementById('editor-container');
            editorContainer.style.opacity = '0.5';

            fetch('/api/upload-image', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.url) {
                        const range = quill.getSelection(true);
                        quill.insertEmbed(range.index, 'image', data.url);
                        quill.setSelection(range.index + 1);
                    } else {
                        alert('Upload failed: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Upload failed: ' + error.message);
                })
                .finally(() => {
                    editorContainer.style.opacity = '1';
                    input.value = ''; // Reset input
                });
        }
    }

    // Update preview
    function updatePreview() {
        const template = document.getElementById('template_content').value;
        const preview = document.getElementById('template-preview');

        if (!template.trim() || template === '<p><br></p>') {
            preview.innerHTML = '<div class="text-center text-muted"><i class="fas fa-code fa-2x mb-2"></i><p>Start typing your HTML template to see a preview here.</p></div>';
            return;
        }

        // Replace merge fields with preview data - BOLD formatting makes it clear
        // Also handle URL-encoded merge fields (%7B%7B...%7D%7D) that Quill uses in href attributes
        let previewContent = template;

        // First, replace URL-encoded merge fields (for href attributes)
        previewContent = previewContent
            .replace(/%7B%7Bpitch_google_maps_link%7D%7D/gi, 'https://maps.google.com/example')
            .replace(/%7B%7Bpitch_name%7D%7D/gi, 'Stanley Deason 3G')
            .replace(/%7B%7Bdate_display%7D%7D/gi, 'Sunday 15 October 2023')
            .replace(/%7B%7Btime_display%7D%7D/gi, '2:30pm')
            .replace(/%7B%7Bteam_name%7D%7D/gi, 'U14 Blue')
            .replace(/%7B%7Bopposition_name%7D%7D/gi, 'Brighton Hawks')
            .replace(/%7B%7Bmanager_email%7D%7D/gi, 'john.smith@withdean.com')
            .replace(/%7B%7Bmanager_phone%7D%7D/gi, '07123 456789')
            .replace(/%7B%7Bmanager_name%7D%7D/gi, 'John Smith')
            .replace(/%7B%7Bmanager_contact%7D%7D/gi, 'john.smith@withdean.com');

        // Then replace normal merge fields (for visible text)
        previewContent = previewContent
            .replace(/\{\{date_display\}\}/g, '<strong>Sunday 15 October 2023</strong>')
            .replace(/\{\{time_display\}\}/g, '<strong>2:30pm</strong>')
            .replace(/\{\{team_name\}\}/g, '<strong>U14 Blue</strong>')
            .replace(/\{\{opposition_name\}\}/g, '<strong>Brighton Hawks</strong>')
            .replace(/\{\{home_away\}\}/g, '<strong>Home</strong>')
            .replace(/\{\{pitch_name\}\}/g, '<strong>Stanley Deason 3G</strong>')
            .replace(/\{\{pitch_address\}\}/g, 'Stanley Deason Leisure Centre, 120 Wilson Avenue, BN2 5BP')
            .replace(/\{\{pitch_parking\}\}/g, 'Ample free parking available at the leisure centre')
            .replace(/\{\{pitch_toilets\}\}/g, 'Toilets available within the main building')
            .replace(/\{\{pitch_opening_notes\}\}/g, '3G pitch opens at 9am. Please arrive in time to mark pitch.')
            .replace(/\{\{pitch_warm_up_notes\}\}/g, '20 minutes warm-up allowed before kick-off')
            .replace(/\{\{pitch_special_instructions\}\}/g, 'Strict footwear policy - flat soled boots only')
            .replace(/\{\{pitch_google_maps_link\}\}/g, '<a href="#" class="text-decoration-none"><strong>View on Google Maps</strong></a>')
            .replace(/\{\{pitch_map_section\}\}/g, '<em class="text-muted">[Map image would appear here]</em>')
            .replace(/\{\{home_colours\}\}/g, 'Withdean Youth FC play in <strong>Blue and Black Shirts</strong>, <strong>Black Shorts</strong> and <strong>Blue and Black Hooped Socks</strong>')
            .replace(/\{\{match_format\}\}/g, '<strong>9v9 - 60 minutes - 30 each way</strong>')
            .replace(/\{\{referee_note\}\}/g, 'Referees have been requested but are TBC')
            .replace(/\{\{manager_name\}\}/g, '<strong>John Smith</strong>')
            .replace(/\{\{manager_email\}\}/g, '<em>john.smith@withdean.com</em>')
            .replace(/\{\{manager_phone\}\}/g, '<em>07123 456789</em>')
            .replace(/\{\{manager_contact\}\}/g, '<em>john.smith@withdean.com</em>')
            .replace(/\{\{email_signature\}\}/g, '<strong>Many thanks<br>Withdean Youth FC</strong>')
            .replace(/\{\{further_instructions_section\}\}/g, '<em class="text-muted">[Any additional instructions would appear here]</em>');

        preview.innerHTML = '<div style="font-family: Arial, sans-serif; font-size: 14px; line-height: 1.4; max-width: none;">' + previewContent + '</div>';
    }

    function clearTemplate() {
        if (confirm('Are you sure you want to clear all template content? This cannot be undone.')) {
            quill.setText('');
            document.getElementById('template_content').value = '';
            updatePreview();
        }
    }

    function insertImageByUrl() {
        const url = prompt('Enter the URL of the image (e.g., https://example.com/logo.png):');
        if (url) {
            // Focus the editor
            quill.focus();
            // Get current selection or default to end
            let range = quill.getSelection();
            let index = range ? range.index : quill.getLength();

            // Insert image
            quill.insertEmbed(index, 'image', url);
            // Move cursor after image
            quill.setSelection(index + 1);
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
        // Load draft if exists and original is empty (e.g. new template)
        // But here we are editing existing template usually.
        // Let's rely on server content first.
        updatePreview();
    });
</script>
{% endblock %}