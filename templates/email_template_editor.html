{% extends "base.html" %}

{% block title %}Email Template Editor - Withdean Youth FC{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-edit text-danger"></i> 
            Email Template Editor
        </h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('settings') }}">Settings</a></li>
                <li class="breadcrumb-item active">Email Template Editor</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-file-alt"></i> Template Editor
                </h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="mb-3">
                        <label for="template_content" class="form-label">Email Template</label>
                        <textarea class="form-control" id="template_content" name="template_content" 
                                  rows="20" required style="font-family: monospace;">{{ template_content }}</textarea>
                        <div class="form-text">
                            Use merge fields (shown in the sidebar) to insert dynamic content.
                            HTML formatting is supported.
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" name="action" value="save" class="btn btn-danger">
                            <i class="fas fa-save"></i> Save Template
                        </button>
                        <button type="submit" name="action" value="reset" class="btn btn-warning"
                                onclick="return confirm('Are you sure you want to reset the template to default? All customizations will be lost.')">
                            <i class="fas fa-undo"></i> Reset to Default
                        </button>
                        <a href="{{ url_for('settings') }}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Preview Section -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-eye"></i> Template Preview
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Preview:</strong> This shows how your template will look with merge fields replaced.
                    Save your changes and generate an email to see the real preview.
                </div>
                <div class="border p-3 bg-light">
                    <div id="template-preview" style="font-family: Arial, sans-serif;">
                        <!-- Preview will be updated via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Merge Fields Card -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-code"></i> Available Merge Fields
                </h6>
            </div>
            <div class="card-body">
                <p class="small text-muted mb-3">
                    Click any merge field below to insert it at your cursor position in the template.
                </p>
                
                <h6 class="small text-primary">Match Information</h6>
                <div class="mb-3">
                    {% for field in ['{{date_display}}', '{{time_display}}', '{{team_name}}', '{{opposition_name}}', '{{match_format}}'] %}
                    <button class="btn btn-sm btn-outline-primary m-1 merge-field-btn" 
                            data-field="{{ field }}" title="Click to insert">
                        {{ field }}
                    </button>
                    {% endfor %}
                </div>
                
                <h6 class="small text-success">Venue Details</h6>
                <div class="mb-3">
                    {% for field in ['{{pitch_name}}', '{{pitch_address}}', '{{pitch_parking}}', '{{pitch_toilets}}', '{{pitch_opening_notes}}', '{{pitch_warm_up_notes}}', '{{pitch_special_instructions}}'] %}
                    <button class="btn btn-sm btn-outline-success m-1 merge-field-btn" 
                            data-field="{{ field }}" title="Click to insert">
                        {{ field }}
                    </button>
                    {% endfor %}
                </div>
                
                <h6 class="small text-warning">Contact & Settings</h6>
                <div class="mb-3">
                    {% for field in ['{{home_colours}}', '{{referee_note}}', '{{manager_name}}', '{{manager_contact}}', '{{email_signature}}'] %}
                    <button class="btn btn-sm btn-outline-warning m-1 merge-field-btn" 
                            data-field="{{ field }}" title="Click to insert">
                        {{ field }}
                    </button>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Help Card -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-question-circle"></i> Template Help
                </h6>
            </div>
            <div class="card-body">
                <h6 class="small">HTML Formatting</h6>
                <ul class="small mb-3">
                    <li><code>&lt;h3&gt;Title&lt;/h3&gt;</code> - Section headers</li>
                    <li><code>&lt;p&gt;&lt;strong&gt;Bold:&lt;/strong&gt; text&lt;/p&gt;</code> - Bold labels</li>
                    <li><code>&lt;br&gt;</code> - Line breaks</li>
                    <li><code>&lt;u&gt;Underlined&lt;/u&gt;</code> - Underlined text</li>
                </ul>
                
                <h6 class="small">Merge Fields</h6>
                <ul class="small mb-3">
                    <li>Merge fields are replaced with actual data when emails are generated</li>
                    <li>Always use the format <code>{{field_name}}</code></li>
                    <li>Empty fields will be replaced with blank text</li>
                </ul>
                
                <div class="alert alert-warning small">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Important:</strong> Don't remove merge fields you want to keep - they ensure your emails have the right information!
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Insert merge field at cursor position
document.querySelectorAll('.merge-field-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const field = this.dataset.field;
        const textarea = document.getElementById('template_content');
        
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const text = textarea.value;
        
        textarea.value = text.substring(0, start) + field + text.substring(end);
        textarea.selectionStart = textarea.selectionEnd = start + field.length;
        textarea.focus();
        
        updatePreview();
    });
});

// Update preview as user types
document.getElementById('template_content').addEventListener('input', updatePreview);

function updatePreview() {
    const template = document.getElementById('template_content').value;
    const preview = document.getElementById('template-preview');
    
    // Simple preview with sample data
    let previewContent = template
        .replace(/\{\{date_display\}\}/g, 'Sunday 15 October 2023')
        .replace(/\{\{time_display\}\}/g, '2:30pm')
        .replace(/\{\{team_name\}\}/g, 'U14 Blue')
        .replace(/\{\{opposition_name\}\}/g, 'Brighton Hawks')
        .replace(/\{\{pitch_name\}\}/g, 'Stanley Deason 3G')
        .replace(/\{\{pitch_address\}\}/g, 'Stanley Deason Leisure Centre, 120 Wilson Avenue, BN2 5BP')
        .replace(/\{\{pitch_parking\}\}/g, 'Stanley Deason Leisure Centre (120 Wilson Avenue, BN2 5BP)')
        .replace(/\{\{pitch_toilets\}\}/g, 'Toilets can be found within the main leisure centre building')
        .replace(/\{\{pitch_opening_notes\}\}/g, '3G Opens at 9am. Mark pitch out with cones.')
        .replace(/\{\{pitch_warm_up_notes\}\}/g, '20 minutes warm up on 3G.')
        .replace(/\{\{pitch_special_instructions\}\}/g, 'Strict Boot Policy - see details above')
        .replace(/\{\{home_colours\}\}/g, 'Withdean Youth FC play in Blue and Black Shirts, Black Shorts and Blue and Black Hooped Socks')
        .replace(/\{\{match_format\}\}/g, '9v9 - 60 minutes - 30 each way')
        .replace(/\{\{referee_note\}\}/g, 'Referees have been requested for all fixtures but are as yet unconfirmed')
        .replace(/\{\{manager_name\}\}/g, 'John Smith')
        .replace(/\{\{manager_contact\}\}/g, '07123 456789')
        .replace(/\{\{email_signature\}\}/g, 'Many thanks<br><br>Withdean Youth FC');
    
    preview.innerHTML = previewContent;
}

// Initialize preview
updatePreview();
</script>
{% endblock %}