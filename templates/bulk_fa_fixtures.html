{% extends "base.html" %}

{% block title %}Bulk FA Fixtures Upload{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-upload"></i> Bulk FA Fixtures Upload
                    </h4>
                    <small>Paste multiple fixture lines from the FA website to automatically create upcoming matches</small>
                </div>
                <div class="card-body">
                    <!-- Instructions -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> How to use:</h6>
                        <ol class="mb-0">
                            <li>Copy multiple fixture lines directly from the FA website</li>
                            <li>Paste them in the text area below</li>
                            <li>Click "Parse and Create Fixtures" to process</li>
                            <li>Only fixtures for your managed teams (Withdean Youth) will be processed</li>
                            <li>Fixtures will be automatically added as upcoming matches</li>
                        </ol>
                    </div>

                    <!-- Example Format -->
                    <div class="alert alert-secondary">
                        <h6><i class="fas fa-code"></i> Expected Format:</h6>
                        <small class="font-monospace">
                            L&nbsp;&nbsp;&nbsp;&nbsp;05/10/25 10:00&nbsp;&nbsp;&nbsp;&nbsp;Worthing United Youth U14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VS&nbsp;&nbsp;&nbsp;&nbsp;Withdean Youth U14 Black&nbsp;&nbsp;&nbsp;&nbsp;Under 14 Division Two Red<br>
                            Cup&nbsp;&nbsp;05/10/25 10:00&nbsp;&nbsp;&nbsp;&nbsp;Withdean Youth U14 White&nbsp;&nbsp;&nbsp;&nbsp;VS&nbsp;&nbsp;&nbsp;&nbsp;Haywards Heath Town Youth U14&nbsp;&nbsp;&nbsp;&nbsp;U14 League Trophy
                        </small>
                    </div>

                    <form method="POST">
                        <div class="mb-3">
                            <label for="fa_fixture_text" class="form-label">
                                <strong>FA Fixture Data:</strong>
                            </label>
                            <textarea class="form-control font-monospace"
                                      id="fa_fixture_text"
                                      name="fa_fixture_text"
                                      rows="12"
                                      placeholder="Paste FA fixture lines here..."
                                      required>{{ fa_fixture_text or '' }}</textarea>
                            <div class="form-text">
                                Paste the fixture lines exactly as they appear on the FA website.
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('dashboard.dashboard_view') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back to Dashboard
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-magic"></i> Parse and Create Fixtures
                            </button>
                        </div>
                    </form>

                    <!-- Results Section -->
                    {% if fixture_preview or created_count is defined %}
                    <hr class="my-4">
                    <div class="results-section">
                        <h5><i class="fas fa-chart-bar"></i> Processing Results</h5>

                        {% if created_count is defined %}
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h3 class="mb-1">{{ created_count }}</h3>
                                        <small>Fixtures Created</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-warning text-dark">
                                    <div class="card-body text-center">
                                        <h3 class="mb-1">{{ error_count or 0 }}</h3>
                                        <small>Errors</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <h3 class="mb-1">{{ (fixture_preview|length) if fixture_preview else 0 }}</h3>
                                        <small>Total Parsed</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if errors and errors|length > 0 %}
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle"></i> Errors Encountered:</h6>
                            <ul class="mb-0">
                                {% for error in errors %}
                                <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        {% if fixture_preview %}
                        <div class="mt-4">
                            <h6><i class="fas fa-eye"></i> Parsed Fixtures Preview:</h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>Team</th>
                                            <th>Opposition</th>
                                            <th>Date & Time</th>
                                            <th>Home/Away</th>
                                            <th>Competition</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for fixture in fixture_preview %}
                                        <tr>
                                            <td>
                                                <strong class="text-primary">{{ fixture.team }}</strong>
                                            </td>
                                            <td>{{ fixture.opposition }}</td>
                                            <td>
                                                <small>
                                                    {{ fixture.datetime.strftime('%a %d %b %Y') }}<br>
                                                    <strong>{{ fixture.datetime.strftime('%H:%M') }}</strong>
                                                </small>
                                            </td>
                                            <td>
                                                <span class="badge bg-{% if fixture.home_away == 'Home' %}success{% else %}primary{% endif %}">
                                                    <i class="fas fa-{% if fixture.home_away == 'Home' %}home{% else %}plane{% endif %}"></i>
                                                    {{ fixture.home_away }}
                                                </span>
                                            </td>
                                            <td>
                                                <small class="text-muted">{{ fixture.competition }}</small>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% if fixture_preview|length >= 5 %}
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i>
                                Showing first 5 fixtures. Total parsed: {{ fixture_preview|length }}
                            </small>
                            {% endif %}
                        </div>
                        {% endif %}

                        {% if created_count and created_count > 0 %}
                        <div class="mt-3">
                            <a href="{{ url_for('dashboard.dashboard_view') }}" class="btn btn-success">
                                <i class="fas fa-calendar"></i> View Updated Dashboard
                            </a>
                            <a href="{{ url_for('tasks.view_tasks') }}" class="btn btn-outline-primary">
                                <i class="fas fa-tasks"></i> View All Tasks
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Additional Help -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-question-circle"></i> Tips & Troubleshooting
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-lightbulb text-warning"></i> Best Practices:</h6>
                            <ul class="small">
                                <li>Copy data directly from the FA website without modification</li>
                                <li>Include all columns in the fixture data</li>
                                <li>Only fixtures for your managed teams will be processed</li>
                                <li>Duplicate fixtures will be automatically detected</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-tools text-info"></i> Common Issues:</h6>
                            <ul class="small">
                                <li>Make sure team names include "Withdean Youth"</li>
                                <li>Check that dates are in DD/MM/YY format</li>
                                <li>Ensure "VS" separator is present between teams</li>
                                <li>Times should be in HH:MM format</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
