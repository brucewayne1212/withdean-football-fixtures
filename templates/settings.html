{% extends "base.html" %}

{% block title %}Settings - Withdean Youth FC{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="mb-0">
                <i class="fas fa-cog text-danger"></i>
                Settings
            </h1>
            <div class="text-muted">
                <i class="fas fa-shield-alt"></i>
                <small>All settings stored locally on this device</small>
            </div>
        </div>
    </div>
</div>

<!-- Compact Settings Overview -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h6 class="mb-0 text-muted">
                    <i class="fas fa-tachometer-alt"></i> Quick Overview
                </h6>
            </div>
            <div class="card-body py-3">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="p-2 rounded bg-primary bg-opacity-10">
                            <div class="h5 mb-0 text-primary">{{ managed_teams|length }}</div>
                            <small class="text-muted">Teams Managed</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-2 rounded bg-success bg-opacity-10">
                            <div class="h5 mb-0 text-success">{{ pitches|length }}</div>
                            <small class="text-muted">Pitches Configured</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-2 rounded bg-info bg-opacity-10">
                            <div class="h6 mb-0 text-info">{{ managed_teams|length * 2 }}</div>
                            <small class="text-muted">Contacts Added</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="p-2 rounded bg-warning bg-opacity-10">
                            <div class="h6 mb-0 text-warning">{{ user_info.created_date[:10] if user_info.created_date
                                else '-' }}</div>
                            <small class="text-muted">Member Since</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Navigation Tabs -->
<ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="teams-tab" data-bs-toggle="tab" data-bs-target="#teams" type="button"
            role="tab">
            <i class="fas fa-users"></i> Teams
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="pitches-tab" data-bs-toggle="tab" data-bs-target="#pitches" type="button"
            role="tab">
            <i class="fas fa-map-marker-alt"></i> Pitches
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="contacts-tab" data-bs-toggle="tab" data-bs-target="#contacts" type="button"
            role="tab">
            <i class="fas fa-address-book"></i> Contacts
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="preferences-tab" data-bs-toggle="tab" data-bs-target="#preferences" type="button"
            role="tab">
            <i class="fas fa-envelope"></i> Email
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="account-tab" data-bs-toggle="tab" data-bs-target="#account" type="button"
            role="tab">
            <i class="fas fa-user-cog"></i> Account
        </button>
    </li>
</ul>

<!-- Tab Content Container -->
<div class="tab-content">

    <!-- Teams Tab -->
    <div class="tab-pane fade show active" id="teams" role="tabpanel" aria-labelledby="teams-tab">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">
                                <i class="fas fa-users"></i> Your Managed Teams ({{ managed_teams|length }})
                            </h5>
                            <small class="text-muted">Select and manage the teams you're responsible for</small>
                        </div>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-danger" data-bs-toggle="modal"
                                data-bs-target="#selectTeamsModal">
                                <i class="fas fa-edit"></i> Select Teams
                            </button>
                            <a href="{{ url_for('imports.bulk_team_upload') }}" class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-upload"></i> Upload Master List
                            </a>
                            <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal"
                                data-bs-target="#addCoachModal">
                                <i class="fas fa-plus"></i> Add Coaches
                            </button>
                            <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#awayMatchModal">
                                <i class="fas fa-plane"></i> Away Match Text
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Club-wide Fixtures URL Section -->
                        <div class="alert alert-info mb-4">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading">
                                        <i class="fas fa-globe"></i> Club-wide Fixtures URL
                                    </h6>
                                    <p class="mb-2 small">
                                        Add a URL that contains all fixtures for your age group/club.
                                        The app will automatically identify and import fixtures for your managed teams.
                                    </p>
                                    {% if org_settings.get('club_fixtures_url') %}
                                    <div class="small text-success mb-2">
                                        <i class="fas fa-check-circle"></i> Club URL configured
                                        <br><small class="text-muted">{{ org_settings.get('club_fixtures_url', '')[:60]
                                            }}{% if org_settings.get('club_fixtures_url', '')|length > 60 %}...{% endif
                                            %}</small>
                                    </div>
                                    {% else %}
                                    <div class="small text-warning">
                                        <i class="fas fa-exclamation-circle"></i> No club URL configured
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="btn-group-vertical ms-2">
                                    <button class="btn btn-sm btn-info" data-bs-toggle="modal"
                                        data-bs-target="#clubFixturesUrlModal">
                                        <i class="fas fa-cog"></i> {% if org_settings.get('club_fixtures_url') %}Edit{%
                                        else %}Configure{% endif %}
                                    </button>
                                    {% if org_settings.get('club_fixtures_url') %}
                                    <button class="btn btn-sm btn-success mt-1" onclick="refreshClubFixtures()"
                                        id="refreshClubFixturesBtn">
                                        <i class="fas fa-sync"></i> Refresh Fixtures
                                    </button>
                                    {% endif %}
                                    <a href="{{ url_for('imports.import_fixtures') }}?method=url"
                                        class="btn btn-sm btn-outline-primary mt-1">
                                        <i class="fas fa-external-link-alt"></i> Import via URL
                                    </a>
                                </div>
                            </div>
                        </div>

                        {% if managed_teams %}
                        <div class="row g-3">
                            {% for team_data in teams_data %}
                            {% set team = team_data.name %}
                            <div class="col-sm-6 col-md-4">
                                <div class="card h-100 border-0 shadow-sm">
                                    <div class="card-body d-flex flex-column">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">
                                                <i class="fas fa-futbol text-danger me-2"></i>{{ team }}
                                            </h6>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-sm btn-outline-info" data-bs-toggle="modal"
                                                    data-bs-target="#teamFaUrlModal" data-team="{{ team }}"
                                                    data-team-id="{{ team_data.id }}"
                                                    data-fa-url="{{ team_data.fa_fixtures_url }}"
                                                    title="FA Fixtures URL">
                                                    <i class="fas fa-link"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
                                                    data-bs-target="#teamKitModal" data-team="{{ team }}"
                                                    title="Kit Colours">
                                                    <i class="fas fa-tshirt"></i>
                                                </button>
                                            </div>
                                        </div>
                                        {% if team_data.fa_fixtures_url %}
                                        <div class="small text-muted mb-2">
                                            <i class="fas fa-check-circle text-success"></i> FA URL configured
                                        </div>
                                        {% else %}
                                        <div class="small text-muted mb-2">
                                            <i class="fas fa-exclamation-circle text-warning"></i> No FA URL
                                        </div>
                                        {% endif %}
                                        {% set team_coaches = user_manager.get_team_coaches(team) %}
                                        {% if team_coaches %}
                                        <div class="small text-muted mb-2 flex-grow-1 coach-summary"
                                            data-team="{{ team|e }}">
                                            {% for coach in team_coaches[:2] %}
                                            <div class="mb-1">
                                                <strong>{{ coach.role or 'Coach' }}:</strong> {{ coach.coach_name[:15]
                                                }}{% if coach.coach_name|length > 15 %}...{% endif %}
                                            </div>
                                            {% endfor %}
                                            {% if team_coaches|length > 2 %}
                                            <small class="text-muted">+ {{ team_coaches|length - 2 }} more
                                                coaches</small>
                                            {% endif %}
                                        </div>
                                        {% else %}
                                        <div class="small text-muted mb-2 flex-grow-1 coach-summary"
                                            data-team="{{ team|e }}">
                                            <i class="fas fa-exclamation-triangle text-warning"></i> No coaches added
                                        </div>
                                        {% endif %}
                                        <div class="mt-auto">
                                            <div class="btn-group btn-group-sm w-100" role="group">
                                                <button class="btn btn-outline-secondary" data-bs-toggle="modal"
                                                    data-bs-target="#teamCoachModal" data-team="{{ team }}"
                                                    title="Manage Coaches">
                                                    <i class="fas fa-user-edit"></i> Manage
                                                </button>
                                                <div class="btn-group" role="group">
                                                    <button class="btn btn-outline-danger dropdown-toggle"
                                                        data-bs-toggle="dropdown" type="button">
                                                        <i class="fas fa-ellipsis-v"></i>
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        <li><button class="dropdown-item text-danger"
                                                                onclick="deleteTeam('{{ team }}')">
                                                                <i class="fas fa-trash"></i> Delete Team
                                                            </button></li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-users-slash fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Teams Selected</h5>
                            <p class="text-muted mb-3">Choose the teams you manage to get started.</p>
                            <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#selectTeamsModal">
                                <i class="fas fa-edit"></i> Select Teams
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pitches Tab -->
    <div class="tab-pane fade" id="pitches" role="tabpanel" aria-labelledby="pitches-tab">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">
                                <i class="fas fa-map-marker-alt"></i> Pitch Configurations ({{ pitches|length }})
                            </h5>
                            <small class="text-muted">Configure venue details, parking, and facilities</small>
                        </div>
                        <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addPitchModal">
                            <i class="fas fa-plus"></i> Add Pitch
                        </button>
                    </div>
                    <div class="card-body">
                        {% if pitches %}
                        <div class="row g-3">
                            {% for pitch_name, pitch in pitches.items() %}
                            <div class="col-md-6">
                                <div class="card h-100 border-left-success">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <h6 class="card-title mb-1">
                                                    <i class="fas fa-stadium text-success me-2"></i>{{ pitch.name }}
                                                </h6>
                                                <small class="text-muted">{{ pitch.address[:35] }}{% if
                                                    pitch.address|length > 35 %}...{% endif %}</small>
                                            </div>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary"
                                                    onclick="editPitch('{{ pitch_name }}')" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-danger"
                                                    onclick="deletePitch('{{ pitch_name }}')" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="small text-muted">
                                            {% if pitch.parking %}
                                            <div><i class="fas fa-car me-1"></i> Parking instructions available</div>
                                            {% endif %}
                                            {% if pitch.opening_notes %}
                                            <div><i class="fas fa-clock me-1"></i> Setup notes included</div>
                                            {% endif %}
                                            {% if pitch.special_instructions %}
                                            <div><i class="fas fa-exclamation-triangle me-1"></i> Special rules apply
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-map-marked fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Pitch Configurations</h5>
                            <p class="text-muted mb-3">Add pitch details to customize emails with venue information.</p>
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addPitchModal">
                                <i class="fas fa-plus"></i> Add First Pitch
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contacts Tab -->
    <div class="tab-pane fade" id="contacts" role="tabpanel" aria-labelledby="contacts-tab">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">
                                <i class="fas fa-address-book"></i> Opponent Team Contacts
                            </h5>
                            <small class="text-muted">Store contact details for teams your squads play against</small>
                        </div>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-danger" data-bs-toggle="modal"
                                data-bs-target="#addContactModal">
                                <i class="fas fa-plus"></i> Add Contact
                            </button>
                            <a href="{{ url_for('imports.bulk_contact_upload') }}"
                                class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-upload"></i> Bulk Upload
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if team_contacts %}
                        <!-- Contact Search -->
                        <div class="mb-3">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="contactSearch"
                                    placeholder="Search teams or contacts...">
                                <button class="btn btn-outline-secondary" type="button" onclick="clearContactSearch()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <small class="text-muted">Filter contacts by team name or contact info</small>
                        </div>

                        <div class="row g-3" id="contactGrid">
                            {% for team_name, contact in team_contacts.items() %}
                            <div class="col-md-6">
                                <div class="card h-100 border-left-info">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <h6 class="card-title mb-1">
                                                    <i class="fas fa-user-tie text-info me-2"></i>{{ team_name }}
                                                </h6>
                                                {% if contact.contact_name %}
                                                <small class="text-muted">{{ contact.contact_name }}</small>
                                                {% endif %}
                                            </div>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary"
                                                    onclick="editContact('{{ team_name }}')" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-danger"
                                                    onclick="deleteContact('{{ team_name }}')" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="d-flex flex-column gap-1">
                                            {% if contact.email %}
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-envelope text-muted me-2" style="width: 14px;"></i>
                                                <code class="small">{{ contact.email }}</code>
                                                <button class="btn btn-sm btn-link ms-1 p-0"
                                                    onclick="copyToClipboard('{{ contact.email }}', 'Email copied!')"
                                                    title="Copy">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                            {% endif %}
                                            {% if contact.phone %}
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-phone text-muted me-2" style="width: 14px;"></i>
                                                <small>{{ contact.phone }}</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-address-book fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Contacts Added</h5>
                            <p class="text-muted mb-3">Store opponent team contacts for easy reference.</p>
                            <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#addContactModal">
                                <i class="fas fa-plus"></i> Add First Contact
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Tab -->
    <div class="tab-pane fade" id="preferences" role="tabpanel" aria-labelledby="preferences-tab">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-envelope"></i> Email Preferences
                        </h5>
                        <small class="text-muted">Configure default email settings and templates</small>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="/settings/preferences">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="default_referee_note" class="form-label">Default Referee
                                            Note</label>
                                        <textarea class="form-control" id="default_referee_note"
                                            name="default_referee_note" rows="2"
                                            placeholder="Where to meet the referee, payment arrangements, etc.">{{ preferences.default_referee_note }}</textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label for="default_colours" class="form-label">Default Home Kit</label>
                                        <input type="text" class="form-control" id="default_colours"
                                            name="default_colours" value="{{ preferences.default_colours }}"
                                            placeholder="e.g., Red shirts, black shorts">
                                    </div>
                                    <div class="mb-3">
                                        <label for="default_day" class="form-label">Primary Match Day</label>
                                        <select class="form-select" id="default_day" name="default_day">
                                            <option value="Saturday" {{ 'selected' if
                                                preferences.default_day=='Saturday' }}>Saturday</option>
                                            <option value="Sunday" {{ 'selected' if preferences.default_day=='Sunday'
                                                }}>Sunday</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="email_signature" class="form-label">Email Signature</label>
                                        <textarea class="form-control" id="email_signature" name="email_signature"
                                            rows="3"
                                            placeholder="Your name, club role, contact details">{{ preferences.email_signature }}</textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-3">
                                <button type="submit" class="btn btn-danger">
                                    <i class="fas fa-save"></i> Save All Preferences
                                </button>
                            </div>
                        </form>

                        <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                            <div>
                                <h6 class="mb-0">Email Templates</h6>
                                <small class="text-muted">Customize your automatic email templates</small>
                            </div>
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('settings.manage_email_template') }}"
                                    class="btn btn-outline-danger btn-sm">
                                    <i class="fas fa-edit"></i> Edit Templates
                                </a>
                                <form method="POST" action="/settings/weekly-sheet" class="d-inline ms-2">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <label for="weekly_sheet_url_small" class="form-label small mb-1 me-1">Fixture Sheet
                                        URL</label>
                                    <input type="url" class="form-control form-control-sm d-inline-block me-1"
                                        id="weekly_sheet_url_small" name="weekly_sheet_url"
                                        value="{{ org_settings.get('weekly_sheet_url', '') }}" style="width: 250px;"
                                        placeholder="Google Sheet URL">
                                    <button type="submit" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-save"></i> Save
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Tab -->
    <div class="tab-pane fade" id="account" role="tabpanel" aria-labelledby="account-tab">
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-user"></i> User Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="userForm" method="POST" action="/settings/user">
                            <div class="mb-3">
                                <label for="name" class="form-label">Name</label>
                                <input type="text" class="form-control" id="name" name="name"
                                    value="{{ user_info.name }}" required>
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email"
                                    value="{{ user_info.email }}">
                            </div>
                            <div class="mb-3">
                                <label for="role" class="form-label">Role</label>
                                <input type="text" class="form-control" id="role" name="role"
                                    value="{{ user_info.role }}" placeholder="e.g., Secretary, Chairman">
                            </div>
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-save"></i> Save User Info
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle"></i> Account Summary
                        </h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Teams Managed:</strong></td>
                                <td><span class="badge bg-primary">{{ managed_teams|length }}</span></td>
                            </tr>
                            <tr>
                                <td><strong>Pitches Configured:</strong></td>
                                <td><span class="badge bg-success">{{ pitches|length }}</span></td>
                            </tr>
                            <tr>
                                <td><strong>Contacts Added:</strong></td>
                                <td><span class="badge bg-info">{{ team_contacts|length }}</span></td>
                            </tr>
                            <tr>
                                <td><strong>Member Since:</strong></td>
                                <td>{{ user_info.created_date[:10] if user_info.created_date else 'Unknown' }}</td>
                            </tr>
                        </table>
                        <hr>
                        <small class="text-muted">
                            <i class="fas fa-shield-alt"></i>
                            All settings are stored locally on this device.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Team Selection Modal -->
<div class="modal fade" id="selectTeamsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="selectTeamsModalTitle">Team Management</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="teamManagementForm">
                <div class="modal-body">
                    <!-- Instructions -->
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>How to manage your teams:</strong> First check the boxes for the teams you want to work
                        with, then choose your action below.
                    </div>

                    <!-- Team Selection -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6><i class="fas fa-check-square"></i> Select Teams:</h6>
                            <div class="row g-2">
                                {% for team in all_teams %}
                                <div class="col-md-6 col-lg-4">
                                    <div class="form-check border rounded p-2 hover-bg-light">
                                        <input class="form-check-input bulk-team-checkbox" type="checkbox" name="teams"
                                            value="{{ team }}" id="team_{{ loop.index }}" {{ 'checked' if team in
                                            managed_teams else '' }}>
                                        <label class="form-check-label fw-medium" for="team_{{ loop.index }}">
                                            {{ team }}
                                        </label>
                                        {% if team in managed_teams %}
                                        <small class="text-success d-block"><i class="fas fa-eye"></i> Currently
                                            managed</small>
                                        {% else %}
                                        <small class="text-muted d-block"><i class="fas fa-eye-slash"></i> Not
                                            managed</small>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Selection Summary -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    <small class="text-muted">
                                        <strong>Selected:</strong> <span id="selectionCount">0</span> teams
                                        (<span id="managedCount">0</span> managed, <span id="newCount">0</span> new)
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <div class="btn-group" role="group">
                        <button type="button" id="manageBtn" class="btn btn-primary">
                            <i class="fas fa-save"></i> Manage Selected
                        </button>
                        <button type="button" id="archiveBtn" class="btn btn-warning">
                            <i class="fas fa-archive"></i> Archive Selected
                        </button>
                        <button type="button" id="deleteBtn" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Delete Selected
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add/Edit Pitch Modal -->
<div class="modal fade" id="addPitchModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pitchModalTitle">Add New Pitch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="pitchForm" method="POST" action="/settings/pitch" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="pitch_name" class="form-label">Pitch Name *</label>
                                <input type="text" class="form-control" id="pitch_name" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label for="pitch_aliases" class="form-label">
                                    <i class="fas fa-tags"></i> Aliases
                                    <small class="text-muted">(comma separated)</small>
                                </label>
                                <input type="text" class="form-control" id="pitch_aliases" name="aliases"
                                    placeholder="e.g. Varndean Lower, Varndean School">
                                <div class="form-text">Alternative names used in spreadsheets</div>
                            </div>
                            <div class="mb-3">
                                <label for="pitch_address" class="form-label">Pitch Address</label>
                                <input type="text" class="form-control" id="pitch_address" name="address">
                            </div>
                            <div class="mb-3">
                                <label for="parking_address" class="form-label">
                                    <i class="fas fa-car"></i> Parking Address
                                    <small class="text-muted">(if different)</small>
                                </label>
                                <input type="text" class="form-control" id="parking_address" name="parking_address"
                                    placeholder="Leave blank if same as pitch address">
                            </div>
                            <div class="mb-3">
                                <label for="pitch_parking" class="form-label">Parking Information</label>
                                <textarea class="form-control" id="pitch_parking" name="parking" rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="pitch_toilets" class="form-label">Toilet Facilities</label>
                                <textarea class="form-control" id="pitch_toilets" name="toilets" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="pitch_special" class="form-label">Special Instructions</label>
                                <textarea class="form-control" id="pitch_special" name="special_instructions" rows="4"
                                    placeholder="e.g., Boot policies, equipment rules, etc."></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="pitch_opening" class="form-label">Setup/Opening Notes</label>
                                <textarea class="form-control" id="pitch_opening" name="opening_notes" rows="3"
                                    placeholder="e.g., Arrival time, goal setup, etc."></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="pitch_warmup" class="form-label">Warm-up Notes</label>
                                <textarea class="form-control" id="pitch_warmup" name="warm_up_notes" rows="2"
                                    placeholder="e.g., Warm-up time, pitch preparation"></textarea>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="custom_map_upload" class="form-label">
                                    <i class="fas fa-map"></i> Custom Map Image
                                    <small class="text-muted">(upload your own estate map)</small>
                                </label>
                                <input type="file" class="form-control" id="custom_map_upload" name="custom_map_upload"
                                    accept="image/*">
                                <div class="form-text">
                                    Upload your custom estate walking map image (JPG, PNG, etc.). This will be included
                                    in emails to help visitors navigate your facilities.
                                </div>
                                <div id="current_map_display" style="display: none; margin-top: 10px;">
                                    <small class="text-muted">Current map:</small>
                                    <div style="text-align: center; margin: 10px 0;">
                                        <img id="current_map_image" src="" alt="Current Map"
                                            style="max-width: 200px; height: auto; border: 1px solid #ddd; border-radius: 4px;">
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-danger"
                                        onclick="removeCurrentMap()">
                                        <i class="fas fa-trash"></i> Remove Current Map
                                    </button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="pitch_google_maps" class="form-label">
                                    <i class="fas fa-map-marker-alt"></i> Google Maps Link
                                    <small class="text-muted">(auto-generated from address)</small>
                                </label>
                                <input type="url" class="form-control" id="pitch_google_maps" name="google_maps_link"
                                    placeholder="Will be auto-generated when you save">
                                <div class="form-text">Auto-generated from address, or enter custom URL</div>
                            </div>

                            <div class="mb-3">
                                <label for="pitch_map_image" class="form-label">
                                    <i class="fas fa-image"></i> Map Image URL
                                    <small class="text-muted">(Google Drive or other image URL)</small>
                                </label>
                                <input type="url" class="form-control" id="pitch_map_image" name="map_image_url"
                                    placeholder="Enter Google Drive or other image URL">
                                <div class="form-text">For Google Drive images, use the direct image URL format</div>
                            </div>

                            <!-- Map Preview Area -->
                            <div id="mapPreview" class="mt-3" style="display: none;">
                                <div class="row">
                                    <!-- Main Map (Pitch + Parking if different) -->
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0"><i class="fas fa-map"></i> Main Map</h6>
                                                <small class="text-muted">Pitch location (+ parking if
                                                    different)</small>
                                            </div>
                                            <div class="card-body text-center">
                                                <img id="mapPreviewImage" src="" alt="Main Map Preview"
                                                    class="img-fluid" style="max-height: 250px;">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Parking Map (if different address) -->
                                    <div id="parkingMapCol" class="col-md-6" style="display: none;">
                                        <div class="card">
                                            <div class="card-header">
                                                <h6 class="mb-0"><i class="fas fa-parking"></i> Parking Map</h6>
                                                <small class="text-muted">Parking location only</small>
                                            </div>
                                            <div class="card-body text-center">
                                                <img id="parkingMapPreviewImage" src="" alt="Parking Map Preview"
                                                    class="img-fluid" style="max-height: 250px;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Save Pitch
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add/Edit Contact Modal -->
<div class="modal fade" id="addContactModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contactModalTitle">Add Team Contact</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="contactForm" method="POST" action="/settings/contacts">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="team_name" class="form-label">Team Name</label>
                        <input type="text" class="form-control" id="team_name" name="team_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="contact_name" class="form-label">Contact Name</label>
                        <input type="text" class="form-control" id="contact_name" name="contact_name">
                    </div>
                    <div class="mb-3">
                        <label for="contact_email" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="contact_email" name="email">
                    </div>
                    <div class="mb-3">
                        <label for="contact_phone" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="contact_phone" name="phone">
                    </div>
                    <div class="mb-3">
                        <label for="contact_notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="contact_notes" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-save"></i> Save Contact
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add/Edit Coach Modal -->
<div class="modal fade" id="addCoachModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="coachModalTitle">Add Coach/Manager</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="coachForm" method="POST" action="/settings/coaches">
                <input type="hidden" id="coach_id" name="coach_id" value="">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="coach_team_name" class="form-label">Team Name</label>
                        <select class="form-control" id="coach_team_name" name="team_name" required>
                            <option value="">Select a team...</option>
                            {% for team in managed_teams %}
                            <option value="{{ team }}">{{ team }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="coach_name" class="form-label">Coach/Manager Name</label>
                        <input type="text" class="form-control" id="coach_name" name="coach_name">
                    </div>
                    <div class="mb-3">
                        <label for="coach_role" class="form-label">Role</label>
                        <select class="form-control" id="coach_role" name="role">
                            <option value="Coach">Coach</option>
                            <option value="Manager">Manager</option>
                            <option value="Assistant Coach">Assistant Coach</option>
                            <option value="Head Coach">Head Coach</option>
                            <option value="Team Manager">Team Manager</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="coach_email" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="coach_email" name="email">
                    </div>
                    <div class="mb-3">
                        <label for="coach_phone" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="coach_phone" name="phone">
                    </div>
                    <div class="mb-3">
                        <label for="coach_notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="coach_notes" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-save"></i> Save Coach/Manager
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Team Kit Colours Modal -->
<div class="modal fade" id="teamKitModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="teamKitModalTitle">Manage Team Kit Colours</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="teamKitForm" method="POST" action="/settings/team-kit">
                <input type="hidden" id="kit_team_name" name="team_name" value="">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Kit Information:</strong> These colours will appear in emails sent to opposition teams
                        for fixtures involving this team.
                        Leave fields blank to use default club colours.
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary"><i class="fas fa-home"></i> Home Kit</h6>
                            <div class="mb-3">
                                <label for="home_shirt" class="form-label">Shirt</label>
                                <input type="text" class="form-control" id="home_shirt" name="home_shirt"
                                    placeholder="e.g., Blue and Black Shirts">
                            </div>
                            <div class="mb-3">
                                <label for="home_shorts" class="form-label">Shorts</label>
                                <input type="text" class="form-control" id="home_shorts" name="home_shorts"
                                    placeholder="e.g., Black Shorts">
                            </div>
                            <div class="mb-3">
                                <label for="home_socks" class="form-label">Socks</label>
                                <input type="text" class="form-control" id="home_socks" name="home_socks"
                                    placeholder="e.g., Blue and Black Hooped Socks">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-warning"><i class="fas fa-plane"></i> Away Kit</h6>
                            <div class="mb-3">
                                <label for="away_shirt" class="form-label">Shirt</label>
                                <input type="text" class="form-control" id="away_shirt" name="away_shirt"
                                    placeholder="e.g., White Shirts">
                            </div>
                            <div class="mb-3">
                                <label for="away_shorts" class="form-label">Shorts</label>
                                <input type="text" class="form-control" id="away_shorts" name="away_shorts"
                                    placeholder="e.g., White Shorts">
                            </div>
                            <div class="mb-3">
                                <label for="away_socks" class="form-label">Socks</label>
                                <input type="text" class="form-control" id="away_socks" name="away_socks"
                                    placeholder="e.g., White Socks">
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-light">
                        <h6 class="mb-2"><i class="fas fa-eye"></i> Preview</h6>
                        <div id="kitPreview" class="small">
                            <strong>Home Kit:</strong> <span id="homeKitPreview">-</span><br>
                            <strong>Away Kit:</strong> <span id="awayKitPreview">-</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-save"></i> Save Kit Colours
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Team Coach Management Modal -->
<div class="modal fade" id="teamCoachModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="teamCoachModalTitle">Manage Team Coaches</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <h6 class="text-primary mb-0" id="currentTeamName"></h6>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="startNewCoachEntry()">
                        <i class="fas fa-plus"></i> Add Additional Coach
                    </button>
                </div>

                <!-- Current Coaches List -->
                <div id="currentCoaches">
                    <!-- Will be populated by JavaScript -->
                </div>

                <!-- Add New Coach Form -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-plus"></i> Add New Coach</h6>
                    </div>
                    <div class="card-body">
                        <form id="teamCoachForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" id="team_coach_team_name" name="team_name">
                            <input type="hidden" id="team_coach_id" name="coach_id">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="team_coach_name" class="form-label">Coach Name *</label>
                                        <input type="text" class="form-control" id="team_coach_name" name="coach_name"
                                            required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="team_coach_role" class="form-label">Role</label>
                                        <select class="form-control" id="team_coach_role" name="role">
                                            <option value="Coach">Coach</option>
                                            <option value="Manager">Manager</option>
                                            <option value="Assistant Coach">Assistant Coach</option>
                                            <option value="Head Coach">Head Coach</option>
                                            <option value="Team Manager">Team Manager</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="team_coach_email" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="team_coach_email" name="email">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="team_coach_phone" class="form-label">Phone</label>
                                        <input type="tel" class="form-control" id="team_coach_phone" name="phone">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="team_coach_notes" class="form-label">Notes</label>
                                <textarea class="form-control" id="team_coach_notes" name="notes" rows="2"></textarea>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-danger" id="teamCoachSubmitBtn">
                                    <i class="fas fa-plus"></i> Add Coach
                                </button>
                                <button type="button" class="btn btn-outline-secondary d-none"
                                    id="teamCoachCancelEditBtn">
                                    Cancel Edit
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Club Fixtures URL Modal -->
<div class="modal fade" id="clubFixturesUrlModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Club-wide Fixtures URL</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="clubFixturesUrlForm" method="POST" action="/settings/club-fixtures/url">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="modal-body">
                    <div id="clubUrlSaveStatus" class="mb-2"></div>
                    <div class="mb-3">
                        <label for="club_fixtures_url" class="form-label">FA Full-Time Club Fixtures URL</label>
                        <input type="url" class="form-control" id="club_fixtures_url" name="club_fixtures_url"
                            placeholder="https://fulltime.thefa.com/fixtures.html?...">
                        <small class="form-text text-muted">
                            Enter the URL from the FA Full-Time fixtures page that shows ALL fixtures for your age
                            group/club.
                            The app will automatically identify and import fixtures for your managed teams.
                        </small>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        This URL should contain all fixtures for your club. The app will match fixtures to your managed
                        teams automatically.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        id="clubUrlCancelBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="clubUrlSaveBtn">
                        <i class="fas fa-save"></i> Save URL
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Team FA Fixtures URL Modal -->
<div class="modal fade" id="teamFaUrlModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="teamFaUrlModalTitle">FA Fixtures URL</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="teamFaUrlForm" method="POST" action="/settings/teams/fa-url">
                <input type="hidden" id="fa_url_team_id" name="team_id" value="">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="fa_url_team_name" class="form-label">Team</label>
                        <input type="text" class="form-control" id="fa_url_team_name" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="fa_fixtures_url" class="form-label">FA Full-Time Fixtures URL</label>
                        <input type="url" class="form-control" id="fa_fixtures_url" name="fa_fixtures_url"
                            placeholder="https://fulltime.thefa.com/fixtures.html?...">
                        <small class="form-text text-muted">
                            Enter the URL from the FA Full-Time fixtures page for this team.
                            You can find this by navigating to the team's fixtures page on the FA website and copying
                            the URL.
                        </small>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        The app will periodically check this URL to automatically import upcoming fixtures.
                        Note: The FA website uses CAPTCHA protection, so automatic updates may require manual
                        intervention.
                    </div>
                    <div id="faUrlRefreshStatus" class="mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-info" id="refreshFaFixturesBtn" onclick="refreshFaFixtures()"
                        style="display: none;">
                        <i class="fas fa-sync"></i> Refresh Fixtures Now
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save URL
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Away Match Text Modal -->
<div class="modal fade" id="awayMatchModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plane text-info"></i> Generate Away Match Text
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>How this works:</strong> Copy a paragraph of text from your team inbox that contains match
                    details, then we'll generate the appropriate response thanking them and providing your contact
                    information.
                </div>

                <!-- Input Section -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-paste"></i> Step 1: Paste Match Details
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="away_match_text" class="form-label">
                                Paste the email/fixture text you received from the opposition team:
                            </label>
                            <textarea class="form-control" id="away_match_text" name="away_match_text" rows="6"
                                placeholder="Paste the email text here... e.g., 'Hi, we would like to arrange a fixture for...'"></textarea>
                            <div class="form-text">The more detail you provide, the better the response we can generate.
                            </div>
                        </div>
                        <button type="button" id="generateBtn" class="btn btn-info" onclick="generateAwayMatchText()">
                            <i class="fas fa-magic"></i> Generate Response Text
                        </button>
                    </div>
                </div>

                <!-- Output Section -->
                <div id="responseSection" style="display: none;">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-check-circle text-success"></i> Step 2: Copy Generated Response
                            </h6>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearResponse()">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="generatedResponse" class="border rounded p-3 bg-light">
                                <!-- Generated response will appear here -->
                            </div>
                            <div class="mt-3">
                                <button type="button" class="btn btn-success btn-sm" onclick="copyGeneratedText()">
                                    <i class="fas fa-copy"></i> Copy to Clipboard
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="copyAndClose()">
                                    <i class="fas fa-check"></i> Copy & Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-info" onclick="generateAwayMatchText()">
                    <i class="fas fa-magic"></i> Generate Text
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Toast notification function
    function showToast(message) {
        // Create toast element
        const toast = document.createElement('div');
        toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #28a745;
        color: white;
        padding: 15px 20px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 9999;
        font-size: 14px;
        max-width: 300px;
        word-wrap: break-word;
    `;
        toast.textContent = message;

        document.body.appendChild(toast);

        // Remove after 3 seconds
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 3000);
    }



    function deletePitch(pitchName) {
        if (confirm(`Are you sure you want to delete the pitch configuration for "${pitchName}"?`)) {
            fetch(`/settings/pitch/${encodeURIComponent(pitchName)}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error deleting pitch');
                    }
                })
                .catch(error => {
                    alert('Error deleting pitch');
                });
        }
    }

    function removeCurrentMap() {
        if (confirm('Are you sure you want to remove the current custom map?')) {
            document.getElementById('current_map_display').style.display = 'none';
            // Note: The actual file will be removed when the form is submitted with a new file or when explicitly deleted
        }
    }

    // Contact management functions
    function copyToClipboard(text, message) {
        navigator.clipboard.writeText(text).then(() => {
            showToast(message || 'Copied to clipboard!');
        }).catch(() => {
            // Fallback for browsers that don't support clipboard API
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                showToast(message || 'Copied to clipboard!');
            } catch (err) {
                alert('Copy to clipboard failed. Please copy manually: ' + text);
            }

            textArea.remove();
        });
    }

    function handleBulkArchive() {
        const selectedTeams = Array.from(document.querySelectorAll('.bulk-team-checkbox:checked')).map(cb => cb.value);

        if (selectedTeams.length === 0) {
            alert('Please select at least one team to archive.');
            return;
        }

        const confirmMessage = `Archive ${selectedTeams.length} teams?\n\nTeams to archive: ${selectedTeams.join(', ')}\n\nArchived teams will be hidden from your dashboard but can be restored later.`;

        if (!confirm(confirmMessage)) {
            return;
        }

        document.getElementById('archiveBtn').disabled = true;
        document.getElementById('archiveBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Archiving...';

        fetch('/settings/teams/bulk-archive', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ teams: selectedTeams })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(`Successfully archived ${data.archived_count} teams!`);
                    bootstrap.Modal.getInstance(document.getElementById('selectTeamsModal')).hide();
                    setTimeout(() => location.reload(), 1500);
                } else {
                    alert('Error archiving teams: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error archiving teams');
                console.error('Error:', error);
            })
            .finally(() => {
                document.getElementById('archiveBtn').disabled = false;
                document.getElementById('archiveBtn').innerHTML = '<i class="fas fa-archive"></i> Archive Selected';
            });
    }

    function updateSelectionSummary() {
        const checkboxes = document.querySelectorAll('.bulk-team-checkbox:checked');
        const totalSelected = checkboxes.length;
        let managedCount = 0;
        let newCount = 0;

        checkboxes.forEach(cb => {
            const teamName = cb.value;
            // Check if team is currently managed by looking at the checkbox state and data attribute
            if (cb.hasAttribute('checked') && cb.getAttribute('checked') === 'checked') {
                managedCount++;
            } else {
                newCount++;
            }
        });

        // Update the summary display
        document.getElementById('selectionCount').textContent = totalSelected;
        document.getElementById('managedCount').textContent = managedCount;
        document.getElementById('newCount').textContent = newCount;
    }

    function editContact(teamName) {
        fetch(`/settings/contacts/${encodeURIComponent(teamName)}`)
            .then(response => response.json())
            .then(contact => {
                document.getElementById('contactModalTitle').textContent = 'Edit Team Contact';
                document.getElementById('team_name').value = contact.team_name || teamName;
                document.getElementById('contact_name').value = contact.contact_name || '';
                document.getElementById('contact_email').value = contact.email || '';
                document.getElementById('contact_phone').value = contact.phone || '';
                document.getElementById('contact_notes').value = contact.notes || '';

                const modal = new bootstrap.Modal(document.getElementById('addContactModal'));
                modal.show();
            })
            .catch(error => {
                alert('Error loading contact information');
            });
    }

    function deleteContact(teamName) {
        if (confirm(`Are you sure you want to delete the contact for ${teamName}?`)) {
            fetch(`/settings/contacts/${encodeURIComponent(teamName)}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast(`Contact for ${teamName} deleted successfully!`);
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        alert('Error deleting contact');
                    }
                })
                .catch(error => {
                    alert('Error deleting contact');
                });
        }
    }

    // Coach/Manager management functions
    function editCoach(teamName) {
        fetch(`/settings/coaches/${encodeURIComponent(teamName)}`)
            .then(response => response.json())
            .then(data => {
                if (Object.keys(data).length > 0) {
                    document.getElementById('coachModalTitle').textContent = 'Edit Coach/Manager';
                    document.getElementById('coach_team_name').value = teamName;
                    document.getElementById('coach_name').value = data.coach_name || '';
                    document.getElementById('coach_role').value = data.role || 'Coach';
                    document.getElementById('coach_email').value = data.email || '';
                    document.getElementById('coach_phone').value = data.phone || '';
                    document.getElementById('coach_notes').value = data.notes || '';

                    // Store coach ID for updating
                    document.getElementById('coach_id').value = data.id || '';
                }

                const modal = new bootstrap.Modal(document.getElementById('addCoachModal'));
                modal.show();
            })
            .catch(error => {
                alert('Error loading coach information');
            });
    }

    function editCoachById(coachId) {
        fetch(`/settings/coaches/id/${coachId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                document.getElementById('coachModalTitle').textContent = 'Edit Coach/Manager';
                document.getElementById('coach_team_name').value = data.team_name || '';
                document.getElementById('coach_name').value = data.coach_name || '';
                document.getElementById('coach_role').value = data.role || 'Coach';
                document.getElementById('coach_email').value = data.email || '';
                document.getElementById('coach_phone').value = data.phone || '';
                document.getElementById('coach_notes').value = data.notes || '';

                // Store coach ID for updating
                document.getElementById('coach_id').value = data.id;

                const modal = new bootstrap.Modal(document.getElementById('addCoachModal'));
                modal.show();
            })
            .catch(error => {
                alert('Error loading coach data');
            });
    }

    function addCoachForTeam(teamName) {
        document.getElementById('coachModalTitle').textContent = 'Add Coach/Manager';
        document.getElementById('coach_team_name').value = teamName;
        document.getElementById('coach_name').value = '';
        document.getElementById('coach_role').value = 'Coach';
        document.getElementById('coach_email').value = '';
        document.getElementById('coach_phone').value = '';
        document.getElementById('coach_notes').value = '';

        // Clear coach ID (this is a new coach)
        document.getElementById('coach_id').value = '';

        const modal = new bootstrap.Modal(document.getElementById('addCoachModal'));
        modal.show();
    }

    function deleteCoach(teamName) {
        if (confirm(`Are you sure you want to delete the coach/manager for ${teamName}?`)) {
            fetch(`/settings/coaches/${encodeURIComponent(teamName)}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showToast(`Coach/Manager for ${teamName} deleted successfully!`);
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        alert('Error deleting coach/manager');
                    }
                })
                .catch(error => {
                    alert('Error deleting coach/manager');
                });
        }
    }

    function deleteCoachById(coachId) {
        if (confirm('Are you sure you want to delete this coach/manager?')) {
            fetch(`/settings/coaches/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    coach_id: coachId
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showToast('Coach/Manager deleted successfully!');
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        alert('Error deleting coach/manager');
                    }
                })
                .catch(error => {
                    alert('Error deleting coach/manager');
                });
        }
    }

    // Reset modal when adding new pitch
    document.addEventListener('DOMContentLoaded', function () {
        const addPitchModal = document.getElementById('addPitchModal');
        addPitchModal.addEventListener('hidden.bs.modal', function () {
            document.getElementById('pitchModalTitle').textContent = 'Add New Pitch';
            document.getElementById('pitchForm').reset();
        });

        // Reset contact modal when closing
        const addContactModal = document.getElementById('addContactModal');
        addContactModal.addEventListener('hidden.bs.modal', function () {
            document.getElementById('contactModalTitle').textContent = 'Add Team Contact';
            document.getElementById('contactForm').reset();
        });

        // Reset coach modal when closing
        const addCoachModal = document.getElementById('addCoachModal');
        addCoachModal.addEventListener('hidden.bs.modal', function () {
            document.getElementById('coachModalTitle').textContent = 'Add Coach/Manager';
            document.getElementById('coachForm').reset();
        });

        // Team kit modal functionality
        const teamKitModal = document.getElementById('teamKitModal');
        teamKitModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const teamName = button.getAttribute('data-team');

            // Set modal title and team name
            document.getElementById('teamKitModalTitle').textContent = `Manage Kit Colours - ${teamName}`;
            document.getElementById('kit_team_name').value = teamName;

            // Load existing kit data for this team
            loadTeamKit(teamName);

            // Update preview on input changes
            ['home_shirt', 'home_shorts', 'home_socks', 'away_shirt', 'away_shorts', 'away_socks'].forEach(field => {
                document.getElementById(field).addEventListener('input', updateKitPreview);
            });

            // Initialize preview
            updateKitPreview();
        });

        teamKitModal.addEventListener('hidden.bs.modal', function () {
            // Clear form when modal closes
            document.getElementById('teamKitForm').reset();
            document.getElementById('homeKitPreview').textContent = '-';
            document.getElementById('awayKitPreview').textContent = '-';
        });

        // Team FA URL modal functionality
        // Club Fixtures URL Modal
        const clubFixturesUrlModal = document.getElementById('clubFixturesUrlModal');
        if (clubFixturesUrlModal) {
            clubFixturesUrlModal.addEventListener('show.bs.modal', function (event) {
                const clubUrl = '{{ org_settings.get("club_fixtures_url", "") }}';
                document.getElementById('club_fixtures_url').value = clubUrl;
                document.getElementById('clubUrlSaveStatus').innerHTML = '';
                const saveBtn = document.getElementById('clubUrlSaveBtn');
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save URL';
            });

            // Handle form submission
            const clubUrlForm = document.getElementById('clubFixturesUrlForm');
            if (clubUrlForm) {
                clubUrlForm.addEventListener('submit', function (e) {
                    e.preventDefault();

                    const formData = new FormData(this);
                    const saveBtn = document.getElementById('clubUrlSaveBtn');
                    const cancelBtn = document.getElementById('clubUrlCancelBtn');
                    const statusDiv = document.getElementById('clubUrlSaveStatus');
                    const originalBtnHTML = saveBtn.innerHTML;

                    // Disable buttons and show loading
                    saveBtn.disabled = true;
                    cancelBtn.disabled = true;
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                    statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Saving URL...</div>';

                    fetch('/settings/club-fixtures/url', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => {
                            if (response.ok) {
                                return response.json();
                            }
                            return response.text().then(text => {
                                throw new Error(text || 'Failed to save URL');
                            });
                        })
                        .then(data => {
                            // Show success message
                            statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> URL saved successfully!<br><small>Reloading page to update...</small></div>';
                            saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved';

                            // Close modal after 2 seconds and reload page
                            setTimeout(() => {
                                const modal = bootstrap.Modal.getInstance(clubFixturesUrlModal);
                                if (modal) {
                                    modal.hide();
                                }
                                // Reload page to show updated status
                                location.reload();
                            }, 2000);
                        })
                        .catch(error => {
                            statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Error: ' + error.message + '</div>';
                            saveBtn.innerHTML = originalBtnHTML;
                            saveBtn.disabled = false;
                            cancelBtn.disabled = false;
                        });
                });
            }
        }

        // Function to refresh club fixtures
        window.refreshClubFixtures = function () {
            const refreshBtn = document.getElementById('refreshClubFixturesBtn');
            const originalHTML = refreshBtn.innerHTML;

            // Disable button and show loading
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';

            // Create status message in the alert box
            const alertBox = refreshBtn.closest('.alert');
            let statusDiv = alertBox.querySelector('.refresh-status');
            if (!statusDiv) {
                statusDiv = document.createElement('div');
                statusDiv.className = 'refresh-status mt-2';
                alertBox.appendChild(statusDiv);
            }
            statusDiv.innerHTML = '<div class="alert alert-info mb-0"><i class="fas fa-spinner fa-spin"></i> Scraping fixtures from FA website...</div>';

            fetch('/settings/club-fixtures/refresh', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
                }
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error('Refresh failed');
                })
                .then(data => {
                    if (data.success) {
                        const teamsMatched = data.teams_matched && data.teams_matched.length > 0
                            ? data.teams_matched.join(', ')
                            : 'None';

                        let summaryHtml = '<div class="alert alert-success mb-0">' +
                            '<h6><i class="fas fa-check-circle"></i> Refresh Complete!</h6>' +
                            '<ul class="mb-2 small">' +
                            '<li><strong>Total fixtures found on FA website:</strong> ' + data.total_fixtures + '</li>' +
                            '<li><strong>Fixtures imported:</strong> ' + data.fixtures_imported + '</li>' +
                            '<li><strong>Teams matched:</strong> ' + teamsMatched + '</li>' +
                            '</ul>';

                        // Add detailed team summary if available
                        if (data.teams_summary && data.teams_summary.length > 0) {
                            summaryHtml += '<div class="border-top pt-2 mt-2"><strong>Team Summary:</strong><ul class="mb-0 small">';
                            data.teams_summary.forEach(team => {
                                summaryHtml += '<li>' + team.name + ': ' + team.fixture_count + ' fixture' + (team.fixture_count !== 1 ? 's' : '') + '</li>';
                            });
                            summaryHtml += '</ul></div>';
                        }

                        summaryHtml += '</div>';
                        statusDiv.innerHTML = summaryHtml;

                        // Optionally reload page after 5 seconds to show updated fixtures
                        setTimeout(() => {
                            if (confirm('Refresh complete! Would you like to reload the page to see the updated fixtures?')) {
                                location.reload();
                            }
                        }, 5000);
                    } else {
                        statusDiv.innerHTML = '<div class="alert alert-danger mb-0"><i class="fas fa-exclamation-circle"></i> Error: ' + (data.error || 'Failed to refresh fixtures') + '</div>';
                    }
                })
                .catch(error => {
                    statusDiv.innerHTML = '<div class="alert alert-danger mb-0"><i class="fas fa-exclamation-circle"></i> Error: ' + error.message + '</div>';
                    console.error('Error:', error);
                })
                .finally(() => {
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = originalHTML;
                });
        };

        const teamFaUrlModal = document.getElementById('teamFaUrlModal');
        teamFaUrlModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const teamName = button.getAttribute('data-team');
            const teamId = button.getAttribute('data-team-id');
            const faUrl = button.getAttribute('data-fa-url') || '';

            // Set modal title and populate form
            document.getElementById('teamFaUrlModalTitle').textContent = `FA Fixtures URL - ${teamName}`;
            document.getElementById('fa_url_team_name').value = teamName;
            document.getElementById('fa_url_team_id').value = teamId;
            document.getElementById('fa_fixtures_url').value = faUrl;

            // Show/hide refresh button based on whether URL exists
            const refreshBtn = document.getElementById('refreshFaFixturesBtn');
            const statusDiv = document.getElementById('faUrlRefreshStatus');
            if (faUrl) {
                refreshBtn.style.display = 'inline-block';
                refreshBtn.setAttribute('data-team-name', teamName);
                statusDiv.innerHTML = '';
            } else {
                refreshBtn.style.display = 'none';
                statusDiv.innerHTML = '';
            }
        });

        // Function to refresh FA fixtures
        function refreshFaFixtures() {
            const refreshBtn = document.getElementById('refreshFaFixturesBtn');
            const teamName = refreshBtn.getAttribute('data-team-name');
            const statusDiv = document.getElementById('faUrlRefreshStatus');

            if (!teamName) {
                statusDiv.innerHTML = '<div class="alert alert-danger">Team name not found</div>';
                return;
            }

            // Disable button and show loading
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
            statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Refreshing fixtures...</div>';

            // Make request to refresh endpoint
            fetch(`/settings/teams/${encodeURIComponent(teamName)}/refresh-fa-fixtures`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value || ''
                }
            })
                .then(response => {
                    if (response.ok) {
                        return response.json().catch(() => ({}));
                    }
                    throw new Error('Refresh failed');
                })
                .then(data => {
                    statusDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> Fixtures refreshed successfully! Please refresh the page to see updates.</div>';
                    refreshBtn.innerHTML = '<i class="fas fa-sync"></i> Refresh Fixtures Now';
                })
                .catch(error => {
                    statusDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle"></i> Error refreshing fixtures. Please try again or check the console.</div>';
                    refreshBtn.innerHTML = '<i class="fas fa-sync"></i> Refresh Fixtures Now';
                    console.error('Error:', error);
                })
                .finally(() => {
                    refreshBtn.disabled = false;
                });
        }

        teamFaUrlModal.addEventListener('hidden.bs.modal', function () {
            // Clear form when modal closes
            document.getElementById('teamFaUrlForm').reset();
        });

        // Team coach modal functionality
        const teamCoachModal = document.getElementById('teamCoachModal');
        teamCoachModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const teamName = button.getAttribute('data-team');

            // Set team name
            document.getElementById('currentTeamName').textContent = teamName;
            document.getElementById('team_coach_team_name').value = teamName;

            // Reset form to add mode
            resetTeamCoachForm(true);

            // Load current coaches for this team
            loadTeamCoaches(teamName);
        });

        const teamCoachForm = document.getElementById('teamCoachForm');
        const teamCoachSubmitBtn = document.getElementById('teamCoachSubmitBtn');
        const teamCoachCancelEditBtn = document.getElementById('teamCoachCancelEditBtn');

        if (teamCoachCancelEditBtn) {
            teamCoachCancelEditBtn.addEventListener('click', () => resetTeamCoachForm());
        }

        if (teamCoachForm) {
            teamCoachForm.addEventListener('submit', function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const teamName = document.getElementById('team_coach_team_name').value;

                fetch('/settings/coaches', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'application/json'
                    }
                })
                    .then(response => response.json().then(data => ({ ok: response.ok, data })))
                    .then(({ ok, data }) => {
                        if (ok && data.success) {
                            this.reset();
                            document.getElementById('team_coach_team_name').value = teamName;
                            document.getElementById('team_coach_id').value = '';
                            loadTeamCoaches(teamName);
                            showToast('Coach details saved!');
                            resetTeamCoachForm(true);
                        } else {
                            throw new Error(data.message || 'Unknown error');
                        }
                    })
                    .catch(error => {
                        alert('Error adding coach: ' + error.message);
                        console.error('Error:', error);
                    });
            });
        }

        // Contact search functionality
        const contactSearchInput = document.getElementById('contactSearch');
        if (contactSearchInput) {
            contactSearchInput.addEventListener('input', filterContacts);

            // Trigger search when user presses Enter
            contactSearchInput.addEventListener('keyup', function (e) {
                if (e.key === 'Enter' || e.keyCode === 13) {
                    filterContacts();
                }
            });
        }
    });

    function loadTeamKit(teamName) {
        // Fetch kit data for the team
        fetch(`/settings/team-kit/${encodeURIComponent(teamName)}`)
            .then(response => response.json())
            .then(kit => {
                // Populate form fields with existing data
                document.getElementById('home_shirt').value = kit.home_shirt || '';
                document.getElementById('home_shorts').value = kit.home_shorts || '';
                document.getElementById('home_socks').value = kit.home_socks || '';
                document.getElementById('away_shirt').value = kit.away_shirt || '';
                document.getElementById('away_shorts').value = kit.away_shorts || '';
                document.getElementById('away_socks').value = kit.away_socks || '';
            })
            .catch(error => {
                console.error('Error loading kit data:', error);
                // If error, leave form blank (this is fine for new teams)
            });
    }

    function updateKitPreview() {
        const homeShirt = document.getElementById('home_shirt').value.trim();
        const homeShorts = document.getElementById('home_shorts').value.trim();
        const homeSocks = document.getElementById('home_socks').value.trim();

        const awayShirt = document.getElementById('away_shirt').value.trim();
        const awayShorts = document.getElementById('away_shorts').value.trim();
        const awaySocks = document.getElementById('away_socks').value.trim();

        // Build home kit description
        const homeParts = [homeShirt, homeShorts, homeSocks].filter(part => part);
        const homeKitText = homeParts.length > 0 ? homeParts.join(', ') : 'Use default club colours';

        // Build away kit description
        const awayParts = [awayShirt, awayShorts, awaySocks].filter(part => part);
        const awayKitText = awayParts.length > 0 ? awayParts.join(', ') : 'Use default club colours';

        // Update preview
        document.getElementById('homeKitPreview').textContent = homeKitText;
        document.getElementById('awayKitPreview').textContent = awayKitText;
    }

    function loadTeamCoaches(teamName) {
        // Fetch coaches for the team
        fetch(`/settings/coaches/team/${encodeURIComponent(teamName)}`)
            .then(response => response.json())
            .then(coaches => {
                const currentCoachesDiv = document.getElementById('currentCoaches');

                if (coaches && coaches.length > 0) {
                    let html = '<div class="card"><div class="card-header"><h6 class="mb-0">Current Coaches</h6></div><div class="card-body">';

                    coaches.forEach((coach, index) => {
                        const coachPayload = encodeURIComponent(JSON.stringify({
                            team: teamName,
                            id: coach.id || '',
                            name: coach.coach_name || '',
                            email: coach.email || '',
                            phone: coach.phone || '',
                            role: coach.role || 'Coach',
                            notes: coach.notes || ''
                        }));

                        const deletePayload = encodeURIComponent(JSON.stringify({
                            team: teamName,
                            id: coach.id || '',
                            name: coach.coach_name || ''
                        }));

                        html += `
                        <div class="row align-items-center mb-2 ${index > 0 ? 'border-top pt-2' : ''}">
                            <div class="col">
                                <strong>${coach.coach_name}</strong>
                                <small class="text-muted d-block">${coach.role || 'Coach'}</small>
                                ${coach.email ? `<small class="text-muted d-block"><i class="fas fa-envelope"></i> ${coach.email}</small>` : ''}
                                ${coach.phone ? `<small class="text-muted d-block"><i class="fas fa-phone"></i> ${coach.phone}</small>` : ''}
                            </div>
                            <div class="col-auto">
                                <button type="button" class="btn btn-sm btn-outline-primary me-2" data-coach="${coachPayload}" onclick="handleEditCoach(this)">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" data-coach="${deletePayload}" onclick="handleDeleteCoach(this)">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    });

                    html += '</div></div>';
                    currentCoachesDiv.innerHTML = html;
                    updateTeamCoachSummary(teamName, coaches);
                } else {
                    currentCoachesDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> No coaches added yet for this team.</div>';
                    updateTeamCoachSummary(teamName, []);
                }
            })
            .catch(error => {
                console.error('Error loading coaches:', error);
                document.getElementById('currentCoaches').innerHTML = '<div class="alert alert-danger">Error loading coaches</div>';
            });
    }

    function deleteTeam(teamName) {
        if (confirm(` PERMANENTLY DELETE TEAM: "${teamName}"?\n\nThis will delete:\n The team\n All fixtures and matches for this team\n All task assignments\n All coach contacts\n\nThis action CANNOT be undone. Are you sure?`)) {
            fetch(`/settings/teams/${encodeURIComponent(teamName)}`, {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast(`Team "${teamName}" deleted permanently!`);
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        alert('Error deleting team: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    alert('Error deleting team');
                    console.error('Error:', error);
                });
        }
    }

    function deleteTeamCoach(teamName, coachName, coachId = '') {
        if (!confirm(`Are you sure you want to remove ${coachName} from ${teamName}?`)) {
            return;
        }

        const payload = coachId ? { coach_id: coachId } : { team_name: teamName, coach_name: coachName };
        const csrfTokenInput = document.querySelector('#teamCoachForm input[name="csrf_token"]');
        const csrfToken = csrfTokenInput ? csrfTokenInput.value : '';

        fetch('/settings/coaches/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify(payload)
        })
            .then(response => response.json().then(data => ({ ok: response.ok, data })))
            .then(({ ok, data }) => {
                if (ok && (data.success || data.status === 'success')) {
                    loadTeamCoaches(teamName);
                    showToast('Coach removed');
                } else {
                    throw new Error(data.message || data.error || 'Unknown error');
                }
            })
            .catch(error => {
                alert('Error deleting coach: ' + error.message);
                console.error('Error:', error);
            });
    }

    function handleEditCoach(button) {
        try {
            const payload = JSON.parse(decodeURIComponent(button.getAttribute('data-coach')));
            editTeamCoach(
                payload.team,
                payload.name,
                payload.email,
                payload.phone,
                payload.role,
                payload.notes,
                payload.id
            );
        } catch (error) {
            console.error('Failed to parse coach data for edit:', error);
        }
    }

    function handleDeleteCoach(button) {
        try {
            const payload = JSON.parse(decodeURIComponent(button.getAttribute('data-coach')));
            deleteTeamCoach(payload.team, payload.name, payload.id);
        } catch (error) {
            console.error('Failed to parse coach data for delete:', error);
        }
    }

    function startNewCoachEntry() {
        resetTeamCoachForm(true);
        const nameInput = document.getElementById('team_coach_name');
        if (nameInput) {
            nameInput.focus();
        }
    }

    function updateTeamCoachSummary(teamName, coaches) {
        const summaryElement = document.querySelector(`.coach-summary[data-team="${escapeSelector(teamName)}"]`);
        if (!summaryElement) {
            return;
        }

        if (!coaches || coaches.length === 0) {
            summaryElement.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> No coaches added';
            return;
        }

        let html = '';
        coaches.slice(0, 2).forEach(coach => {
            const role = coach.role || 'Coach';
            const name = coach.coach_name || '';
            const shortenedName = name.length > 15 ? `${name.slice(0, 15)}...` : name;
            html += `<div class="mb-1"><strong>${role}:</strong> ${shortenedName}</div>`;
        });

        if (coaches.length > 2) {
            html += `<small class="text-muted">+ ${coaches.length - 2} more coaches</small>`;
        }

        summaryElement.innerHTML = html;
    }

    function escapeSelector(value) {
        if (window.CSS && CSS.escape) {
            return CSS.escape(value);
        }
        return value.replace(/([ #;?%&,.+*~\\':"!^$[\]()=>|\/@])/g, '\\$1');
    }

    function editTeamCoach(teamName, coachName, email = '', phone = '', role = 'Coach', notes = '', coachId = '') {
        document.getElementById('team_coach_team_name').value = teamName;
        document.getElementById('team_coach_id').value = coachId;
        document.getElementById('team_coach_name').value = coachName;
        document.getElementById('team_coach_email').value = email || '';
        document.getElementById('team_coach_phone').value = phone || '';
        document.getElementById('team_coach_role').value = role || 'Coach';
        document.getElementById('team_coach_notes').value = notes || '';

        const submitBtn = document.getElementById('teamCoachSubmitBtn');
        submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
        submitBtn.classList.remove('btn-danger');
        submitBtn.classList.add('btn-success');

        const cancelBtn = document.getElementById('teamCoachCancelEditBtn');
        cancelBtn.classList.remove('d-none');
    }

    function resetTeamCoachForm(skipReload = false) {
        const form = document.getElementById('teamCoachForm');
        form.reset();
        const teamName = document.getElementById('currentTeamName').textContent;
        document.getElementById('team_coach_team_name').value = teamName;
        document.getElementById('team_coach_id').value = '';
        document.getElementById('team_coach_role').value = 'Coach';

        const submitBtn = document.getElementById('teamCoachSubmitBtn');
        submitBtn.innerHTML = '<i class="fas fa-plus"></i> Add Coach';
        submitBtn.classList.add('btn-danger');
        submitBtn.classList.remove('btn-success');

        const cancelBtn = document.getElementById('teamCoachCancelEditBtn');
        cancelBtn.classList.add('d-none');

        if (!skipReload && teamName) {
            loadTeamCoaches(teamName);
        }
    }

    // Team Management Modal Functions
    document.addEventListener('DOMContentLoaded', function () {
        // Team management modal initialization
        const teamManagementModal = document.getElementById('selectTeamsModal');
        if (teamManagementModal) {
            // Handle manage button click
            document.getElementById('manageBtn').addEventListener('click', handleManageTeams);

            // Handle archive button click
            document.getElementById('archiveBtn').addEventListener('click', handleBulkArchive);

            // Handle delete button click
            document.getElementById('deleteBtn').addEventListener('click', handleBulkDelete);

            // Handle checkbox changes to update selection summary
            document.addEventListener('change', function (e) {
                if (e.target.classList.contains('bulk-team-checkbox')) {
                    updateSelectionSummary();
                }
            });

            // Initialize modal state
            teamManagementModal.addEventListener('show.bs.modal', function () {
                updateSelectionSummary();
            });
        }
    });

    function updateSelectionSummaryOld() {
        // Legacy function kept for compatibility - replaced by updateSelectionSummary()
        updateSelectionSummary();
    }

    function handleManageTeams() {
        const form = document.getElementById('teamManagementForm');
        const formData = new FormData(form);

        // Convert FormData to URLSearchParams for the POST request
        const searchParams = new URLSearchParams(formData);

        document.getElementById('manageBtn').disabled = true;
        document.getElementById('manageBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

        fetch('/settings/teams', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: searchParams.toString()
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Team selections updated successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('selectTeamsModal')).hide();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert('Error updating team selections');
                }
            })
            .catch(error => {
                alert('Error updating team selections');
                console.error('Error:', error);
            })
            .finally(() => {
                document.getElementById('manageBtn').disabled = false;
                document.getElementById('manageBtn').innerHTML = '<i class="fas fa-save"></i> Manage Selected';
            });
    }

    function handleBulkDelete() {
        const selectedTeams = Array.from(document.querySelectorAll('.bulk-team-checkbox:checked')).map(cb => cb.value);

        if (selectedTeams.length === 0) {
            alert('Please select at least one team to delete.');
            return;
        }

        const confirmMessage = ` PERMANENTLY DELETE ${selectedTeams.length} TEAMS?\n\nTeams to delete: ${selectedTeams.join(', ')}\n\nThis will delete:\n All teams\n All fixtures and matches\n All task assignments\n All coach contacts\n\nThis action CANNOT be undone. Are you sure?`;

        if (!confirm(confirmMessage)) {
            return;
        }

        document.getElementById('deleteBtn').disabled = true;
        document.getElementById('deleteBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';

        fetch('/settings/teams/bulk-delete', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ teams: selectedTeams })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(`Successfully deleted ${data.deleted_count} teams!`);
                    bootstrap.Modal.getInstance(document.getElementById('selectTeamsModal')).hide();
                    setTimeout(() => location.reload(), 1500);
                } else {
                    alert('Error deleting teams: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error deleting teams');
                console.error('Error:', error);
            })
            .finally(() => {
                document.getElementById('deleteBtn').disabled = false;
                document.getElementById('deleteBtn').innerHTML = '<i class="fas fa-trash"></i> Delete Selected';
            });
    }

    // Away Match Text Generation Functions
    function generateAwayMatchText() {
        const textInput = document.getElementById('away_match_text').value.trim();

        if (!textInput) {
            alert('Please paste some match details first.');
            return;
        }

        // Show loading state
        const generateBtn = document.getElementById('generateBtn');
        const originalText = generateBtn.innerHTML;
        generateBtn.disabled = true;
        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

        // Call API to generate response text
        fetch('/api/generate-away-match-response', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                input_text: textInput
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Hide input section and show output section
                    document.getElementById('responseSection').style.display = 'block';

                    // Scroll to response section
                    document.getElementById('responseSection').scrollIntoView({ behavior: 'smooth' });

                    // Populate the response text
                    document.getElementById('generatedResponse').innerHTML = data.response_text;

                    // Update button text
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = originalText;

                    showToast('Response text generated successfully!');
                } else {
                    alert('Error: ' + (data.message || 'Failed to generate response text'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error generating response text: ' + error.message);
            })
            .finally(() => {
                generateBtn.disabled = false;
                generateBtn.innerHTML = originalText;
            });
    }

    function clearResponse() {
        document.getElementById('generatedResponse').innerHTML = '';
        document.getElementById('away_match_text').value = '';
        document.getElementById('responseSection').style.display = 'none';
        showToast('Response cleared.');
    }

    function copyGeneratedText() {
        const responseElement = document.getElementById('generatedResponse');
        const textToCopy = responseElement.textContent || responseElement.innerText;

        if (navigator.clipboard && window.isSecureContext) {
            // Use the modern clipboard API
            navigator.clipboard.writeText(textToCopy).then(() => {
                showToast('Response text copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                fallbackCopyTextToClipboard(textToCopy);
            });
        } else {
            // Use the fallback method
            fallbackCopyTextToClipboard(textToCopy);
            showToast('Response text copied to clipboard!');
        }
    }

    function copyAndClose() {
        copyGeneratedText();
        // Close the modal after a brief delay
        setTimeout(() => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('awayMatchModal'));
            modal.hide();
        }, 500);
    }

    function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            document.execCommand('copy');
        } catch (err) {
            console.error('Fallback: Oops, unable to copy', err);
        } finally {
            textArea.remove();
        }
    }

    // Contact search functionality
    function filterContacts() {
        const searchTerm = document.getElementById('contactSearch').value.toLowerCase().trim();
        const contactGrid = document.getElementById('contactGrid');
        const contactCards = contactGrid.querySelectorAll('.col-md-6');
        let visibleCount = 0;

        contactCards.forEach(card => {
            const teamName = card.querySelector('h6.card-title').textContent.toLowerCase();
            const contactName = card.querySelector('small.text-muted').textContent.toLowerCase();
            const email = card.querySelector('.small code') ? card.querySelector('.small code').textContent.toLowerCase() : '';
            const phone = card.querySelector('.small:not(code)') ? card.querySelector('.small:not(code)').textContent.toLowerCase() : '';

            // Check if search term matches team name, contact name, email, or phone
            const matchesSearch = searchTerm === '' ||
                teamName.includes(searchTerm) ||
                contactName.includes(searchTerm) ||
                email.includes(searchTerm) ||
                phone.includes(searchTerm);

            if (matchesSearch) {
                card.style.display = '';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        // Update search results status
        updateSearchResults(searchTerm, visibleCount, contactCards.length);
    }

    function clearContactSearch() {
        document.getElementById('contactSearch').value = '';
        filterContacts();
        document.getElementById('contactSearch').focus();
    }

    function updateSearchResults(searchTerm, visibleCount, totalCount) {
        // Remove existing search results message
        const existingMessage = document.getElementById('searchResultsMessage');
        if (existingMessage) {
            existingMessage.remove();
        }

        // Add search results message if searching
        if (searchTerm && totalCount > 0) {
            const messageDiv = document.createElement('div');
            messageDiv.id = 'searchResultsMessage';
            messageDiv.className = 'mb-3';

            if (visibleCount === 0) {
                messageDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> No contacts found matching "' + searchTerm + '"</div>';
            } else if (visibleCount < totalCount) {
                messageDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle"></i> Showing ' + visibleCount + ' of ' + totalCount + ' contacts matching "' + searchTerm + '"</div>';
            }

            const searchContainer = document.querySelector('.input-group').parentNode;
            searchContainer.appendChild(messageDiv);
        }
    }
</script>

<script>
    function editPitch(pitchName) {
        fetch('/settings/pitch/' + encodeURIComponent(pitchName))
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('pitchModalTitle').textContent = 'Edit Pitch';
                document.getElementById('pitch_name').value = data.name || '';
                document.getElementById('pitch_address').value = data.address || '';
                document.getElementById('pitch_aliases').value = (data.aliases || []).join(', ');
                document.getElementById('pitch_parking').value = data.parking || '';
                document.getElementById('pitch_toilets').value = data.toilets || '';
                document.getElementById('pitch_special').value = data.special_instructions || '';
                document.getElementById('pitch_opening').value = data.opening_notes || '';
                document.getElementById('pitch_warmup').value = data.warm_up_notes || '';
                document.getElementById('pitch_map_image').value = data.map_image_url || '';
                document.getElementById('pitch_google_maps').value = data.google_maps_link || '';
                document.getElementById('parking_address').value = data.parking_address || '';

                // Handle custom map display
                if (data.custom_map_filename) {
                    document.getElementById('current_map_display').style.display = 'block';
                    document.getElementById('current_map_image').src = '/static/uploads/maps/' + data.custom_map_filename;
                } else {
                    document.getElementById('current_map_display').style.display = 'none';
                }

                var modal = new bootstrap.Modal(document.getElementById('addPitchModal'));
                modal.show();
            })
            .catch(error => {
                alert('Error loading pitch data: ' + error.message);
            });
    }

    function deletePitch(pitchName) {
        if (confirm('Are you sure you want to delete the pitch configuration for "' + pitchName + '"?')) {
            fetch('/settings/pitch/' + encodeURIComponent(pitchName), {
                method: 'DELETE'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Pitch "' + pitchName + '" deleted successfully!');
                        setTimeout(function () {
                            location.reload();
                        }, 1000);
                    } else {
                        alert('Error deleting pitch');
                    }
                })
                .catch(error => {
                    alert('Error deleting pitch');
                });
        }
    }

    // Reset modal when closing
    document.addEventListener('DOMContentLoaded', function () {
        var addPitchModal = document.getElementById('addPitchModal');
        if (addPitchModal) {
            addPitchModal.addEventListener('hidden.bs.modal', function () {
                document.getElementById('pitchModalTitle').textContent = 'Add New Pitch';
                document.getElementById('pitchForm').reset();
            });
        }
    });

    function previewMap() {
        var address = document.getElementById('pitch_address').value.trim();
        var parkingAddress = document.getElementById('parking_address').value.trim();

        if (!address) {
            alert('Please enter an address first to preview the map.');
            return;
        }

        // Show loading state
        var previewDiv = document.getElementById('mapPreview');
        var previewImage = document.getElementById('mapPreviewImage');
        previewDiv.style.display = 'block';
        previewImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkxvYWRpbmcgbWFwLi4uPC90ZXh0Pjwvc3ZnPg==';

        // Generate map URLs
        fetch('/api/generate-map-urls', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                address: address,
                parking_address: parkingAddress
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error generating map: ' + data.error);
                    previewDiv.style.display = 'none';
                    return;
                }

                // Update form fields with generated URLs (but preserve custom Google Drive URLs)
                var currentMapUrl = document.getElementById('pitch_map_image').value;
                if (data.map_image_url) {
                    // Only update if field is empty or doesn't contain a Google Drive URL
                    if (!currentMapUrl || !currentMapUrl.includes('drive.google.com')) {
                        document.getElementById('pitch_map_image').value = data.map_image_url;
                    }
                    previewImage.src = data.map_image_url;
                } else {
                    previewImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhmOWZhIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzY2NzMzZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEFQSSBrZXkgY29uZmlndXJlZDwvdGV4dD48L3N2Zz4=';
                }

                if (data.google_maps_link) {
                    document.getElementById('pitch_google_maps').value = data.google_maps_link;
                }

                // Handle parking map preview
                var parkingMapCol = document.getElementById('parkingMapCol');
                var parkingPreviewImage = document.getElementById('parkingMapPreviewImage');

                if (data.parking_map_image_url) {
                    parkingMapCol.style.display = 'block';
                    parkingPreviewImage.src = data.parking_map_image_url;
                } else {
                    parkingMapCol.style.display = 'none';
                }
            })
            .catch(error => {
                alert('Error generating map: ' + error.message);
                previewDiv.style.display = 'none';
            });
    }

    // Handle Weekly Sheet URL form submission
    document.querySelector('form[action="/settings/weekly-sheet"]').addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;

        // Disable button and show loading
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

        fetch('/settings/weekly-sheet', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    alert('Google Sheet URL saved successfully!');
                } else {
                    alert('Error: ' + (data.error || 'Failed to save URL'));
                }
            })
            .catch(error => {
                alert('Error saving URL: ' + error.message);
            })
            .finally(() => {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            });
    });
</script>
{% endblock %}