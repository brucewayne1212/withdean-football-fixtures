{% extends "base.html" %}

{% block title %}Bulk Upload - {{ upload_type|title }} - Withdean Youth FC{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-upload text-danger"></i>
            Bulk {{ upload_type|title }} Upload
        </h1>
    </div>
</div>

{% if error_message %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i>
            {{ error_message }}
        </div>
    </div>
</div>
{% endif %}

{% if upload_type in ['coaches', 'contacts'] %}

{% if show_confirmation %}
<!-- Confirmation Step -->
<div class="row">
    <div class="col-12">
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            <strong>Data Parsed Successfully!</strong><br>
            {% if auto_mapped %}
            We automatically detected and mapped your columns.
            {% else %}
            Your column mappings have been applied.
            {% endif %}
            Please review the data below before saving.
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-eye"></i> Preview: {{ (preview_data.coaches if upload_type == 'coaches' else
                    preview_data.contacts)|length }} {{ upload_type|title }}
                </h5>
            </div>
            <div class="card-body">
                {% if preview_data.errors %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>{{ preview_data.errors|length }} rows had errors and will be skipped:</strong>
                    <ul class="mb-0 mt-2">
                        {% for error in preview_data.errors[:5] %}
                        <li>Row {{ error.row }}: {{ error.message }}</li>
                        {% endfor %}
                        {% if preview_data.errors|length > 5 %}
                        <li>... and {{ preview_data.errors|length - 5 }} more errors</li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}

                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>Team</th>
                                {% if upload_type == 'coaches' %}
                                <th>Coach Name</th>
                                {% else %}
                                <th>Contact Name</th>
                                {% endif %}
                                <th>Email</th>
                                <th>Phone</th>
                                {% if upload_type == 'coaches' %}
                                <th>Role</th>
                                {% endif %}
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set items = preview_data.coaches if upload_type == 'coaches' else preview_data.contacts
                            %}
                            {% for item in items[:10] %}
                            <tr>
                                <td><strong>{{ item.team_name }}</strong></td>
                                <td>{{ item.coach_name if upload_type == 'coaches' else item.contact_name }}</td>
                                <td>{{ item.email or '-' }}</td>
                                <td>{{ item.phone or '-' }}</td>
                                {% if upload_type == 'coaches' %}
                                <td>{{ item.role }}</td>
                                {% endif %}
                                <td>{{ item.notes[:30] }}{% if item.notes and item.notes|length > 30 %}...{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            {% if items|length > 10 %}
                            <tr>
                                <td colspan="{{ 6 if upload_type == 'coaches' else 5 }}" class="text-center text-muted">
                                    ... and {{ items|length - 10 }} more {{ upload_type }}
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>

                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <textarea name="csv_data" style="display: none;">{{ csv_data }}</textarea>
                    <input type="hidden" name="confirm_save" value="true">
                    {% if update_existing %}
                    <input type="hidden" name="update_existing" value="on">
                    {% endif %}
                    {% for csv_col, db_field in mappings.items() %}
                    <input type="hidden" name="mapping_{{ csv_col }}" value="{{ db_field }}">
                    {% endfor %}

                    <div class="d-flex gap-2 mt-3">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-save"></i> Save {{ preview_data.coaches|length }} Coaches
                        </button>
                        <a href="{{ url_for('imports.bulk_coach_upload') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Start Over
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle"></i> Summary
                </h6>
            </div>
            <div class="card-body">
                <p><strong>Total {{ upload_type }} to save:</strong> {{ (preview_data.coaches if upload_type ==
                    'coaches' else preview_data.contacts)|length }}</p>
                <p><strong>Teams affected:</strong> {{ preview_data.teams|length }}</p>
                {% if preview_data.errors %}
                <p><strong>Rows with errors:</strong> {{ preview_data.errors|length }}</p>
                {% endif %}
                {% if update_existing %}
                <p><strong>Update mode:</strong> Existing coaches will be updated</p>
                {% else %}
                <p><strong>Create mode:</strong> Only new coaches will be added</p>
                {% endif %}

                <hr>
                <p class="small"><strong>Teams to be updated:</strong></p>
                <div class="small">
                    {% for team in preview_data.teams %}
                    <span class="badge bg-danger me-1 mb-1">{{ team }}</span>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

{% elif show_mapping %}
<!-- Column Mapping Interface -->
<div class="row">
    <div class="col-12">
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Column Mapping Required</strong><br>
            We couldn't automatically match your CSV columns. Please map them manually below.
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-arrows-alt-h"></i> Map Your CSV Columns
                </h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <textarea name="csv_data" style="display: none;">{{ csv_data }}</textarea>
                    <input type="hidden" name="mapping_step" value="true">
                    {% if update_existing %}
                    <input type="hidden" name="update_existing" value="on">
                    {% endif %}

                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Your CSV Column</th>
                                    <th>Sample Data</th>
                                    <th>Maps To</th>
                                    <th>Confidence</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for header in analysis.headers %}
                                <tr>
                                    <td><strong>{{ header }}</strong></td>
                                    <td class="small text-muted">
                                        {% for row in analysis.sample_rows[:2] %}
                                        {% if row[header] %}
                                        "{{ row[header][:50] }}{% if row[header]|length > 50 %}...{% endif %}"<br>
                                        {% endif %}
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <select class="form-select" name="mapping_{{ header }}"
                                            onchange="validateMapping()">
                                            <option value="">-- Ignore this column --</option>
                                            <option value="team_name" {% if
                                                analysis.suggested_mapping.get(header)=='team_name' %}selected{% endif
                                                %}>
                                                Team Name (Required)
                                            </option>
                                            {% if upload_type == 'coaches' %}
                                            <option value="coach_name" {% if
                                                analysis.suggested_mapping.get(header)=='coach_name' %}selected{% endif
                                                %}>
                                                Coach Name (Required)
                                            </option>
                                            {% else %}
                                            <option value="contact_name" {% if
                                                analysis.suggested_mapping.get(header)=='contact_name' %}selected{%
                                                endif %}>
                                                Contact Name (Required)
                                            </option>
                                            {% endif %}
                                            <option value="email" {% if analysis.suggested_mapping.get(header)=='email'
                                                %}selected{% endif %}>
                                                Email
                                            </option>
                                            <option value="phone" {% if analysis.suggested_mapping.get(header)=='phone'
                                                %}selected{% endif %}>
                                                Phone
                                            </option>
                                            {% if upload_type == 'coaches' %}
                                            <option value="role" {% if analysis.suggested_mapping.get(header)=='role'
                                                %}selected{% endif %}>
                                                Role
                                            </option>
                                            {% endif %}
                                            <option value="notes" {% if analysis.suggested_mapping.get(header)=='notes'
                                                %}selected{% endif %}>
                                                Notes
                                            </option>
                                        </select>
                                    </td>
                                    <td>
                                        {% if analysis.confidence_scores.get(header) %}
                                        {% set confidence = analysis.confidence_scores[header] %}
                                        {% if confidence >= 90 %}
                                        <span class="badge bg-success">{{ confidence }}% - Excellent</span>
                                        {% elif confidence >= 70 %}
                                        <span class="badge bg-warning">{{ confidence }}% - Good</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ confidence }}% - Low</span>
                                        {% endif %}
                                        {% else %}
                                        <span class="text-muted">No match</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div class="alert alert-info mt-3" id="mapping-validation">
                        <i class="fas fa-info-circle"></i>
                        <span id="validation-message">Please ensure Team Name and Coach Name are mapped to
                            proceed.</span>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-danger" id="proceed-btn" disabled>
                            <i class="fas fa-upload"></i> Proceed with Mapping
                        </button>
                        <a href="{{ url_for('imports.bulk_coach_upload' if upload_type == 'coaches' else 'imports.bulk_contact_upload') }}"
                            class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Start Over
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-eye"></i> Preview Data
                </h6>
            </div>
            <div class="card-body">
                <p class="small"><strong>Detected {{ analysis.headers|length }} columns:</strong></p>
                <div class="small">
                    {% for header in analysis.headers %}
                    <span class="badge bg-light text-dark me-1 mb-1">{{ header }}</span>
                    {% endfor %}
                </div>

                {% if analysis.sample_rows %}
                <p class="small mt-3"><strong>First row preview:</strong></p>
                <div class="small font-monospace bg-light p-2 rounded">
                    {% for key, value in analysis.sample_rows[0].items() %}
                    <strong>{{ key }}:</strong> {{ value[:30] }}{% if value|length > 30 %}...{% endif %}<br>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- Coaches Upload Form -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-file-csv"></i> Upload Coach Data
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" onsubmit="return validateForm()">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label for="contact_file" class="form-label">CSV or Excel File</label>
                        <input type="file" class="form-control" id="contact_file" name="contact_file"
                            accept=".csv,.txt,.xlsx,.xls">
                        <div class="form-text">
                            Upload a CSV or Excel file with {{ upload_type }} information. See format requirements on
                            the right.
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="update_existing" name="update_existing">
                            <label class="form-check-label" for="update_existing">
                                Update existing {{ upload_type }} if they already exist (match by team + name)
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="preview_text" class="form-label">Preview Data (Optional)</label>
                        <textarea class="form-control" id="preview_text" name="preview_text" rows="6"
                            placeholder="Or paste CSV data directly here..."></textarea>
                        <div class="form-text">
                            You can paste CSV data directly instead of uploading a file.
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-upload"></i> Upload {{ upload_type|title }}
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="validatePreview()">
                            <i class="fas fa-check"></i> Validate Preview
                        </button>
                        <a href="{{ url_for('settings.settings_view') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Settings
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle"></i> CSV Format Requirements
                </h6>
            </div>
            <div class="card-body">
                <p class="small"><strong>Required Columns:</strong></p>
                <ul class="small">
                    <li><code>team_name</code> - Must match existing team</li>
                    {% if upload_type == 'coaches' %}
                    <li><code>coach_name</code> - Full name of coach</li>
                    {% else %}
                    <li><code>contact_name</code> - Full name of contact</li>
                    {% endif %}
                </ul>

                <p class="small mt-3"><strong>Optional Columns:</strong></p>
                <ul class="small">
                    <li><code>email</code> - Email address</li>
                    <li><code>phone</code> - Phone number</li>
                    {% if upload_type == 'coaches' %}
                    <li><code>role</code> - Coach, Manager, Assistant, etc.</li>
                    {% endif %}
                    <li><code>notes</code> - Additional notes</li>
                </ul>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-download"></i> Sample CSV
                </h6>
            </div>
            <div class="card-body">
                <small class="font-monospace">
                    {% if upload_type == 'coaches' %}
                    team_name,coach_name,email,phone,role
                    Withdean Youth U14 White,John Smith,john@email.com,07123456789,Head Coach
                    Withdean Youth U14 White,Jane Doe,jane@email.com,07987654321,Assistant Coach
                    Withdean Youth U13 Red,Mike Johnson,mike@email.com,,Manager
                    {% else %}
                    team_name,contact_name,email,phone,notes
                    Mile Oak Youth U7 Orange,Tony Boland,tnyblnd@gmail.com,07739 396004,Manager
                    Eastbourne Town Youth U9 Green,Ben Lewis,benlewis@5wayssoccer.co.uk,7971254817,
                    Fishersgate Flyers Youth U9,Ashley Harrocks,ashleyharrocks90@icloud.com,,
                    {% endif %}
                </small>
                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="downloadSample()">
                        <i class="fas fa-download"></i> Download Sample
                    </button>
                </div>
            </div>
        </div>

        {% if managed_teams %}
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-users"></i> Your Teams
                </h6>
            </div>
            <div class="card-body">
                <div class="small">
                    {% for team in managed_teams[:10] %}
                    <span class="badge bg-danger me-1 mb-1">{{ team }}</span>
                    {% endfor %}
                    {% if managed_teams|length > 10 %}
                    <div class="text-muted mt-1">...and {{ managed_teams|length - 10 }} more</div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% endif %}

{% else %}
<!-- Other upload types (contacts, etc.) -->
<div class="row">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            This feature is coming soon! You'll be able to upload multiple {{ upload_type }} via CSV file.
        </div>

        <a href="{{ url_for('settings.settings_view') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Settings
        </a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if upload_type in ['coaches', 'contacts'] %}
<script>
    const UPLOAD_TYPE = '{{ upload_type }}';

    function validateMapping() {
        const selects = document.querySelectorAll('select[name^="mapping_"]');
        const mappedFields = new Set();
        let hasTeamName = false;
        let hasCoachName = false;
        let hasContactName = false;

        // Check what fields are mapped
        selects.forEach(select => {
            const value = select.value;
            if (value) {
                if (mappedFields.has(value)) {
                    // Duplicate mapping detected
                    showMappingError(`Multiple columns mapped to "${value}". Each field can only be mapped once.`);
                    return;
                }
                mappedFields.add(value);

                if (value === 'team_name') hasTeamName = true;
                if (value === 'coach_name') hasCoachName = true;
                if (value === 'contact_name') hasContactName = true;
            }
        });

        const proceedBtn = document.getElementById('proceed-btn');
        const validationMessage = document.getElementById('validation-message');

        if (hasTeamName && (hasCoachName || hasContactName)) {
            proceedBtn.disabled = false;
            validationMessage.innerHTML = '✅ Ready to proceed! Required fields are mapped.';
            document.getElementById('mapping-validation').className = 'alert alert-success mt-3';
        } else {
            proceedBtn.disabled = true;
            const missing = [];
            if (!hasTeamName) missing.push('Team Name');
            if (UPLOAD_TYPE === 'coaches' && !hasCoachName) missing.push('Coach Name');
            if (UPLOAD_TYPE === 'contacts' && !hasContactName) missing.push('Contact Name');
            validationMessage.innerHTML = `❌ Missing required fields: ${missing.join(', ')}`;
            document.getElementById('mapping-validation').className = 'alert alert-warning mt-3';
        }
    }

    function showMappingError(message) {
        const validationMessage = document.getElementById('validation-message');
        validationMessage.innerHTML = `❌ ${message}`;
        document.getElementById('mapping-validation').className = 'alert alert-danger mt-3';
        document.getElementById('proceed-btn').disabled = true;
    }

    // Run validation on page load
    document.addEventListener('DOMContentLoaded', function () {
        validateMapping();
    });

    function validateForm() {
        const fileInput = document.getElementById('contact_file');
        const previewText = document.getElementById('preview_text').value.trim();

        if (!fileInput.files.length && !previewText) {
            alert('Please either upload a CSV/Excel file or paste CSV data in the preview area.');
            return false;
        }

        return true;
    }

    function validatePreview() {
        const previewText = document.getElementById('preview_text').value.trim();
        if (!previewText) {
            alert('Please paste CSV data in the preview area first.');
            return;
        }

        // Basic CSV validation
        const lines = previewText.split('\n').filter(line => line.trim());
        if (lines.length < 2) {
            alert('CSV data should have at least a header row and one data row.');
            return;
        }

        const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
        const requiredHeaders = UPLOAD_TYPE === 'coaches' ? ['team_name', 'coach_name'] : ['team_name', 'contact_name'];
        const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));

        if (missingHeaders.length > 0) {
            alert(`Missing required columns: ${missingHeaders.join(', ')}`);
            return;
        }

        alert(`✅ Validation passed!\n\nFound ${lines.length - 1} ${UPLOAD_TYPE} records with required columns.\nHeaders: ${headers.join(', ')}`);
    }

    function downloadSample() {
        let csvContent = '';
        if (UPLOAD_TYPE === 'coaches') {
            csvContent = `team_name,coach_name,email,phone,role
Withdean Youth U14 White,John Smith,john@email.com,07123456789,Head Coach
Withdean Youth U14 White,Jane Doe,jane@email.com,07987654321,Assistant Coach
Withdean Youth U13 Red,Mike Johnson,mike@email.com,,Manager`;
        } else {
            csvContent = `team_name,contact_name,email,phone,notes
Mile Oak Youth U7 Orange,Tony Boland,tnyblnd@gmail.com,07739 396004,Manager
Eastbourne Town Youth U9 Green,Ben Lewis,benlewis@5wayssoccer.co.uk,7971254817,
Fishersgate Flyers Youth U9,Ashley Harrocks,ashleyharrocks90@icloud.com,,`;
        }

        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${UPLOAD_TYPE}_sample.csv`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }
</script>
{% endif %}
{% endblock %}